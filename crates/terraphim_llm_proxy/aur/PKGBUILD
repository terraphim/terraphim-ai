# Maintainer: Terraphim Team <team@terraphim.ai>
pkgname=terraphim-llm-proxy
pkgver=0.1.0
pkgrel=1
pkgdesc="Production-ready intelligent LLM routing proxy for Claude Code"
arch=('x86_64')
url="https://github.com/terraphim/terraphim-llm-proxy"
license=('MIT' 'Apache-2.0')
depends=('gcc-libs' 'openssl')
makedepends=('cargo')
source=("$pkgname-$pkgver.tar.gz::https://github.com/terraphim/terraphim-llm-proxy/archive/v$pkgver.tar.gz")
sha256sums=('{{SOURCE_SHA256}}')

prepare() {
  cd "$pkgname-$pkgver"
  export RUSTUP_TOOLCHAIN=stable
  cargo fetch --locked --target "$(rustc -vV | sed -n 's/host: //p')"
}

build() {
  cd "$pkgname-$pkgver"
  export RUSTUP_TOOLCHAIN=stable
  export CARGO_TARGET_DIR=target
  cargo build --release --frozen
}

check() {
  cd "$pkgname-$pkgver"
  export RUSTUP_TOOLCHAIN=stable
  cargo test --frozen
}

package() {
  cd "$pkgname-$pkgver"
  install -Dm0755 -t "$pkgdir/usr/bin/" "target/release/terraphim-llm-proxy"
  install -Dm0644 -t "$pkgdir/usr/share/licenses/$pkgname/" LICENSE
  install -Dm0644 -t "$pkgdir/usr/share/doc/$pkgname/" README.md
  install -Dm0644 config.example.toml "$pkgdir/etc/terraphim-llm-proxy/config.toml"

  # Create systemd user service
  install -Dm0644 /dev/stdin "$pkgdir/usr/lib/systemd/user/terraphim-llm-proxy.service" << EOF
[Unit]
Description=Terraphim LLM Proxy
Documentation=https://github.com/terraphim/terraphim-llm-proxy
After=network.target

[Service]
Type=simple
ExecStart=/usr/bin/terraphim-llm-proxy --config %h/.config/terraphim-llm-proxy/config.toml
Restart=on-failure
RestartSec=5

[Install]
WantedBy=default.target
EOF

  # Create example user config directory
  install -Dm0644 config.example.toml "$pkgdir/usr/share/doc/$pkgname/user-config.toml.example"
}