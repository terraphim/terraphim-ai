# v0.1.9: Fixing the 4x Streaming Bug and Dropping OpenSSL

**Author:** Terraphim Team
**Date:** 2026-02-14
**Tags:** Release, Bug Fix, SSE, Streaming, Rustls, Cross-Compilation
**Release:** [v0.1.9 on GitHub](https://github.com/terraphim/terraphim-llm-proxy/releases/tag/v0.1.9)

---

## The Bug: Every Response Printed Four Times

A user running OpenClaw through the proxy noticed something wrong. Every streamed response appeared four times. Not approximately -- exactly four copies, concatenated into the output.

A quick curl test against the proxy confirmed it:

```
data: {"choices":[{"delta":{"content":"AL"}}]}
data: {"choices":[{"delta":{"content":"PHA"}}]}
data: {"choices":[{"delta":{"content":" BR"}}]}
data: {"choices":[{"delta":{"content":"AV"}}]}
data: {"choices":[{"delta":{"content":"O"}}]}
...token-by-token deltas (correct)...
data: {"choices":[{"delta":{"content":"ALPHA BRAVO CHARLIE"}}]}
data: {"choices":[{"delta":{"content":"ALPHA BRAVO CHARLIE"}}]}
data: {"choices":[{"delta":{"content":"ALPHA BRAVO CHARLIE"}}]}
```

The text streamed in token-by-token, then the entire output repeated three more times as full blocks.

## Root Cause: OpenAI's Responses API Sends Everything Multiple Ways

The `openai-codex` provider uses OpenAI's Responses API, which streams content through SSE events. What we did not initially account for is that the API sends the same text through multiple event types:

| Event | What it contains | Should emit? |
|-------|-----------------|--------------|
| `response.output_text.delta` | Incremental token | Yes -- this is the stream |
| `response.output_text.done` | Full accumulated text | No -- summary only |
| `response.content_part.done` | Full content part text | No -- summary only |
| `response.output_item.done` | Full message item | No -- summary only |
| `response.completed` | Final response object | Already guarded |

Our SSE parser in `parse_codex_sse_event()` was faithfully converting all of these into Chat Completions chunks. The delta events produced the correct token-by-token stream, then each summary event re-emitted the entire text.

## The Fix: Seven Lines

The `response.completed` handler already had a guard:

```rust
if !state.emitted_content_or_tool {
    // Only emit from completed if nothing else did (recovery path)
}
```

The fix was applying the same guard to the four summary event types. When delta events have already streamed the content, summary events are silently skipped. If no deltas arrived (edge case), the first summary event serves as a recovery path.

The change touched one function in `src/client.rs`. Three new tests verify the behavior:

- Summary events return `None` when deltas already emitted
- Summary events still work as recovery when no deltas were received
- All summary event types are covered (done, content_part, output_item)

## Dropping OpenSSL for Rustls

While fixing CI for the release, we hit a second problem: the ARM64 Linux cross-build failed because `openssl-sys` could not find the aarch64 cross-compilation headers.

Instead of adding more cross-compilation dependencies, we switched from `native-tls` (which uses OpenSSL on Linux) to `rustls`:

```toml
# Before
reqwest = { version = "0.12", features = ["json", "stream"] }

# After
reqwest = { version = "0.12", default-features = false, features = ["json", "stream", "rustls-tls"] }
```

This removed 138 lines from `Cargo.lock` and eliminated the OpenSSL dependency entirely. The build now cross-compiles cleanly for all six targets without any system SSL libraries.

## Release: Six Platforms, One Command

v0.1.9 ships pre-built binaries for every platform we support:

| Platform | Binary | Size |
|----------|--------|------|
| Linux x86_64 (glibc) | `terraphim-llm-proxy-x86_64-unknown-linux-gnu` | 6.9 MB |
| Linux x86_64 (musl, static) | `terraphim-llm-proxy-x86_64-unknown-linux-musl` | 7.0 MB |
| Linux ARM64 | `terraphim-llm-proxy-aarch64-unknown-linux-gnu` | 6.4 MB |
| macOS x86_64 | `terraphim-llm-proxy-x86_64-apple-darwin` | 6.7 MB |
| macOS ARM64 (Apple Silicon) | `terraphim-llm-proxy-aarch64-apple-darwin` | 6.3 MB |
| Windows x86_64 | `terraphim-llm-proxy-x86_64-pc-windows-msvc` | 6.8 MB |

Plus a `.deb` package for Debian/Ubuntu.

For systems with older glibc (like our production box running Pop!_OS 20.04), the musl static build works out of the box with no runtime dependencies.

Deploy:

```bash
curl -sL https://github.com/terraphim/terraphim-llm-proxy/releases/download/v0.1.9/terraphim-llm-proxy-x86_64-unknown-linux-musl.tar.gz \
  | tar xz -C /usr/local/bin/
systemctl restart terraphim-llm-proxy
```

## CI Changes

Two other CI fixes landed in this release:

1. **Clippy clean**: Resolved all warnings (`dead_code` on deserialized-but-unused JWT fields, `derivable_impls` for `Message::default()`, `single_match` in codex client tests). The CI now passes `cargo clippy -- -D warnings` on stable.

2. **Security audit non-blocking**: The `cargo audit` step still runs but no longer gates the release. Transitive dependency advisories (lru `RUSTSEC-2026-0002`, yanked `half` crate) are tracked but do not block binary distribution.

## Verification

After deployment, we ran Claude Code through the proxy on production:

```bash
ANTHROPIC_BASE_URL=http://127.0.0.1:3456 \
ANTHROPIC_API_KEY=$KEY \
claude --print 'List exactly 5 fruits, numbered 1-5, one per line.'
```

Output:

```
1. Apple
2. Banana
3. Orange
4. Mango
5. Strawberry
```

One copy. No duplication.

---

**Full changelog:** [v0.1.8...v0.1.9](https://github.com/terraphim/terraphim-llm-proxy/compare/v0.1.8...v0.1.9)
**Issues closed:** [#96](https://github.com/terraphim/terraphim-llm-proxy/issues/96), [#106](https://github.com/terraphim/terraphim-llm-proxy/issues/106)
