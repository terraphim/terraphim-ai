name: Docker Multi-Architecture Build

on:
  workflow_call:
    inputs:
      platforms:
        description: 'Target platforms (comma-separated)'
        required: false
        type: string
        default: 'linux/amd64,linux/arm64,linux/arm/v7'
      ubuntu-versions:
        description: 'Ubuntu versions to build (JSON array)'
        required: false
        type: string
        default: '["20.04", "22.04"]'
      push:
        description: 'Push images to registry'
        required: false
        type: boolean
        default: false
      tag:
        description: 'Docker image tag'
        required: false
        type: string
        default: 'latest'
      dockerhub-username:
        description: 'Docker Hub username'
        required: false
        type: string
        default: ''
      test_run:
        description: 'Test run without pushing'
        required: false
        type: boolean
        default: false
    secrets:
      DOCKERHUB_TOKEN:
        description: 'Docker Hub token'
        required: false
      OP_SERVICE_ACCOUNT_TOKEN:
        description: '1Password service account token'
        required: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  DOCKERHUB_IMAGE: terraphim/terraphim-server

jobs:
  # Pre-build frontend to avoid SASS issues in Docker
  build-frontend:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 20
          cache: yarn
          cache-dependency-path: desktop/yarn.lock

      - name: Build frontend
        working-directory: ./desktop
        run: |
          yarn install --frozen-lockfile
          yarn build

      - name: Upload frontend artifacts
        uses: actions/upload-artifact@v5
        with:
          name: frontend-dist
          path: desktop/dist/
          retention-days: 1

  build-and-push:
    needs: build-frontend
    runs-on: [self-hosted, Linux, X64]
    strategy:
      fail-fast: false
      matrix:
        ubuntu-version: ${{ fromJSON(inputs.ubuntu-versions) }}
    outputs:
      ghcr-image: ${{ steps.meta.outputs.tags }}
      dockerhub-enabled: ${{ steps.dockerhub-check.outputs.enabled }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: desktop/dist/

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container
          driver-opts: |
            network=host
          buildkitd-flags: |
            --allow-insecure-entitlement security.insecure
            --allow-insecure-entitlement network.host

      - name: Log in to GitHub Container Registry
        if: inputs.push
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install 1Password CLI
        if: inputs.push
        uses: 1password/install-cli-action@v2
        continue-on-error: true

      - name: Load DockerHub credentials from 1Password
        id: dockerhub-creds
        if: inputs.push
        continue-on-error: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
        run: |
          if [ -n "$OP_SERVICE_ACCOUNT_TOKEN" ]; then
            DOCKERHUB_USER=$(op read "op://TerraphimPlatform/DockerHubTokenGithub/username" 2>/dev/null || echo "")
            DOCKERHUB_TOKEN=$(op read "op://TerraphimPlatform/DockerHubTokenGithub/token" 2>/dev/null || echo "")
            if [ -n "$DOCKERHUB_USER" ] && [ -n "$DOCKERHUB_TOKEN" ]; then
              echo "DOCKERHUB_USERNAME=$DOCKERHUB_USER" >> $GITHUB_ENV
              echo "DOCKERHUB_TOKEN=$DOCKERHUB_TOKEN" >> $GITHUB_ENV
              echo "has_dockerhub=true" >> $GITHUB_OUTPUT
              echo "DockerHub credentials loaded from 1Password"
            else
              echo "has_dockerhub=false" >> $GITHUB_OUTPUT
              echo "DockerHub credentials not found in 1Password"
            fi
          else
            echo "has_dockerhub=false" >> $GITHUB_OUTPUT
            echo "No 1Password token available"
          fi

      - name: Check DockerHub availability
        id: dockerhub-check
        run: |
          if [ -n "${{ env.DOCKERHUB_TOKEN }}" ] || [ -n "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
            echo "enabled=true" >> $GITHUB_OUTPUT
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
          fi

      - name: Log in to Docker Hub
        if: inputs.push && steps.dockerhub-check.outputs.enabled == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME || inputs.dockerhub-username }}
          password: ${{ env.DOCKERHUB_TOKEN || secrets.DOCKERHUB_TOKEN }}
        continue-on-error: true

      - name: Extract metadata for GHCR
        id: meta-ghcr
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ inputs.tag }}-ubuntu${{ matrix.ubuntu-version }}
            type=raw,value=latest-ubuntu${{ matrix.ubuntu-version }},enable=${{ github.ref == format('refs/heads/{0}', github.event.repository.default_branch) }}
            type=semver,pattern={{version}}-ubuntu${{ matrix.ubuntu-version }}
            type=semver,pattern={{major}}.{{minor}}-ubuntu${{ matrix.ubuntu-version }}
          labels: |
            org.opencontainers.image.title=Terraphim Server
            org.opencontainers.image.description=Privacy-first AI assistant with semantic search
            org.opencontainers.image.vendor=Terraphim AI
            ubuntu.version=${{ matrix.ubuntu-version }}

      - name: Extract metadata for DockerHub
        id: meta-dockerhub
        if: steps.dockerhub-check.outputs.enabled == 'true'
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKERHUB_IMAGE }}
          tags: |
            type=raw,value=${{ inputs.tag }}-ubuntu${{ matrix.ubuntu-version }}
            type=raw,value=latest-ubuntu${{ matrix.ubuntu-version }},enable=${{ github.ref == format('refs/heads/{0}', github.event.repository.default_branch) }}
            type=semver,pattern={{version}}-ubuntu${{ matrix.ubuntu-version }}
            type=semver,pattern={{major}}.{{minor}}-ubuntu${{ matrix.ubuntu-version }}
          labels: |
            org.opencontainers.image.title=Terraphim Server
            org.opencontainers.image.description=Privacy-first AI assistant with semantic search
            org.opencontainers.image.vendor=Terraphim AI
            ubuntu.version=${{ matrix.ubuntu-version }}

      - name: Build and push to GHCR
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.multiarch
          platforms: ${{ inputs.platforms }}
          push: ${{ inputs.push }}
          tags: ${{ steps.meta-ghcr.outputs.tags }}
          labels: ${{ steps.meta-ghcr.outputs.labels }}
          build-args: |
            UBUNTU_VERSION=${{ matrix.ubuntu-version }}
            RUST_VERSION=1.92.0
            NODE_VERSION=20
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false
          sbom: false

      - name: Build and push to DockerHub
        if: inputs.push && steps.dockerhub-check.outputs.enabled == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.multiarch
          platforms: ${{ inputs.platforms }}
          push: true
          tags: ${{ steps.meta-dockerhub.outputs.tags }}
          labels: ${{ steps.meta-dockerhub.outputs.labels }}
          build-args: |
            UBUNTU_VERSION=${{ matrix.ubuntu-version }}
            RUST_VERSION=1.92.0
            NODE_VERSION=20
          cache-from: type=gha
          provenance: false
          sbom: false

      - name: Verify GHCR build
        if: inputs.push
        run: |
          echo "Verifying multi-architecture build for Ubuntu ${{ matrix.ubuntu-version }}:"
          docker buildx imagetools inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.tag }}-ubuntu${{ matrix.ubuntu-version }}

      - name: Verify DockerHub build
        if: inputs.push && steps.dockerhub-check.outputs.enabled == 'true'
        run: |
          echo "Verifying DockerHub build for Ubuntu ${{ matrix.ubuntu-version }}:"
          docker buildx imagetools inspect ${{ env.DOCKERHUB_IMAGE }}:${{ inputs.tag }}-ubuntu${{ matrix.ubuntu-version }} || true

  # Create the 'latest' tag pointing to the most recent Ubuntu LTS (22.04)
  create-latest-tag:
    needs: build-and-push
    runs-on: [self-hosted, Linux, X64]
    if: inputs.push && !inputs.test_run

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install 1Password CLI
        uses: 1password/install-cli-action@v2
        continue-on-error: true

      - name: Load DockerHub credentials from 1Password
        id: dockerhub-creds
        continue-on-error: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
        run: |
          if [ -n "$OP_SERVICE_ACCOUNT_TOKEN" ]; then
            DOCKERHUB_USER=$(op read "op://TerraphimPlatform/DockerHubTokenGithub/username" 2>/dev/null || echo "")
            DOCKERHUB_TOKEN=$(op read "op://TerraphimPlatform/DockerHubTokenGithub/token" 2>/dev/null || echo "")
            if [ -n "$DOCKERHUB_USER" ] && [ -n "$DOCKERHUB_TOKEN" ]; then
              echo "DOCKERHUB_USERNAME=$DOCKERHUB_USER" >> $GITHUB_ENV
              echo "DOCKERHUB_TOKEN=$DOCKERHUB_TOKEN" >> $GITHUB_ENV
              echo "has_dockerhub=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Log in to Docker Hub
        if: steps.dockerhub-creds.outputs.has_dockerhub == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}
        continue-on-error: true

      - name: Create 'latest' tag for GHCR (pointing to Ubuntu 22.04)
        run: |
          # Create manifest for 'latest' tag pointing to Ubuntu 22.04
          docker buildx imagetools create \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.tag }}-ubuntu22.04

          # Also create a tag without ubuntu suffix if this is a version tag
          if [[ "${{ inputs.tag }}" =~ ^v[0-9] ]]; then
            docker buildx imagetools create \
              --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.tag }} \
              ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.tag }}-ubuntu22.04
          fi

      - name: Create 'latest' tag for DockerHub (pointing to Ubuntu 22.04)
        if: steps.dockerhub-creds.outputs.has_dockerhub == 'true'
        run: |
          # Create manifest for 'latest' tag pointing to Ubuntu 22.04
          docker buildx imagetools create \
            --tag ${{ env.DOCKERHUB_IMAGE }}:latest \
            ${{ env.DOCKERHUB_IMAGE }}:${{ inputs.tag }}-ubuntu22.04 || true

          # Also create a tag without ubuntu suffix if this is a version tag
          if [[ "${{ inputs.tag }}" =~ ^v[0-9] ]]; then
            docker buildx imagetools create \
              --tag ${{ env.DOCKERHUB_IMAGE }}:${{ inputs.tag }} \
              ${{ env.DOCKERHUB_IMAGE }}:${{ inputs.tag }}-ubuntu22.04 || true
          fi

  build-summary:
    needs: [build-frontend, build-and-push, create-latest-tag]
    runs-on: [self-hosted, Linux, X64]
    if: always()

    steps:
      - name: Build Summary
        run: |
          echo "## Docker Multi-Architecture Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "| Ubuntu Version | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|--------|" >> $GITHUB_STEP_SUMMARY

          UBUNTU_VERSIONS='${{ inputs.ubuntu-versions }}'
          for version in $(echo $UBUNTU_VERSIONS | jq -r '.[]'); do
            if [[ "${{ needs.build-and-push.result }}" == "success" ]]; then
              echo "| $version | Success |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $version | Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Platforms:** ${{ inputs.platforms }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Push to Registry:** ${{ inputs.push }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ inputs.tag }}" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Images" >> $GITHUB_STEP_SUMMARY
          echo "- **GHCR:** \`ghcr.io/${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.build-and-push.outputs.dockerhub-enabled }}" == "true" ]]; then
            echo "- **DockerHub:** \`${{ env.DOCKERHUB_IMAGE }}:latest\`" >> $GITHUB_STEP_SUMMARY
          fi
