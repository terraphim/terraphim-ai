name: CI Native (GitHub Actions + Docker Buildx)

on:
  push:
    branches: [main, CI_migration]
    tags:
      - "*.*.*"
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

concurrency:
  group: ci-${{ github.ref }}

# cancel-in-progress: true

jobs:
  setup:
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 15
    outputs:
      cache-key: ${{ steps.cache.outputs.key }}
      ubuntu-versions: ${{ steps.ubuntu.outputs.versions }}
      rust-targets: ${{ steps.targets.outputs.targets }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          clean: false
          fetch-depth: 0
      
      - name: Clean target directory
        run: |
          rm -rf target || true
          mkdir -p target
        
      - name: Generate cache key
        id: cache
        run: |
          HASH=$(sha256sum Cargo.lock 2>/dev/null | cut -d' ' -f1 || echo "no-lock")
          echo "key=v1-${HASH:0:16}" >> $GITHUB_OUTPUT
      
      - name: Set Ubuntu versions
        id: ubuntu
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] || [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo 'versions=["18.04", "20.04", "22.04", "24.04"]' >> $GITHUB_OUTPUT
          else
            echo 'versions=["22.04"]' >> $GITHUB_OUTPUT
          fi
      
      - name: Set Rust targets
        id: targets
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] || [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo 'targets=["x86_64-unknown-linux-gnu", "aarch64-unknown-linux-gnu", "x86_64-unknown-linux-musl"]' >> $GITHUB_OUTPUT
          else
            echo 'targets=["x86_64-unknown-linux-gnu"]' >> $GITHUB_OUTPUT
          fi
      
  lint-and-format:
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 15
    needs: [setup]
    steps:
      - name: Clean workspace before checkout
        shell: bash
        run: |
          sudo rm -rf target || true
          sudo rm -rf .cargo || true
          find . -name "*.lock" -type f -delete 2>/dev/null || true
          
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          clean: false
      
      - name: Install build dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -yqq --no-install-recommends \
            build-essential \
            clang \
            libclang-dev \
            llvm-dev \
            pkg-config \
            libssl-dev \
            libglib2.0-dev \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libsoup2.4-dev \
            libjavascriptcoregtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.87.0
          components: rustfmt, clippy
      
      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ needs.setup.outputs.cache-key }}-cargo-lint-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ needs.setup.outputs.cache-key }}-cargo-lint-
      
      - name: Run format and linting checks
        run: ./scripts/ci-check-format.sh