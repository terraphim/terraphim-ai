name: Publish Rust Crates

on:
  workflow_dispatch:
    inputs:
      crate:
        description: 'Specific crate to publish (optional)'
        required: false
        type: string
      dry_run:
        description: 'Run in dry-run mode only'
        required: false
        type: boolean
        default: true
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  publish:
    runs-on: [self-hosted, Linux, terraphim, production, docker]
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Install 1Password CLI
        run: |
          curl -sSf https://downloads.1password.com/linux/keys/1password.asc | \
            gpg --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/$(dpkg --print-architecture) stable main" | \
            sudo tee /etc/apt/sources.list.d/1password.list
          sudo apt update && sudo apt install op -y

      - name: Authenticate with 1Password
        run: |
          # Set up 1Password authentication for CI
          echo "${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}" | op account add --service-account-token

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-publish-${{ hashFiles('**/Cargo.lock') }}

      - name: Test crates before publishing
        run: |
          cargo test --workspace --lib --quiet
          cargo check --workspace --all-targets --quiet

      - name: Get crates.io token from 1Password
        id: token
        run: |
          TOKEN=$(op read "op://TerraphimPlatform/crates.io.token/token")
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Publish crates in dependency order
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.token.outputs.token }}
        run: |
          # Make script executable
          chmod +x ./scripts/publish-crates.sh

          # Prepare script arguments
          ARGS=""
          if [[ -n "${{ inputs.crate }}" ]]; then
            ARGS="$ARGS --crate ${{ inputs.crate }}"
          fi

          if [[ -n "${{ github.event.inputs.dry_run }}" && "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            ARGS="$ARGS --dry-run"
          elif [[ "${{ github.event_name }}" == "push" && startsWith(github.ref, 'refs/tags/v') ]]; then
            # Extract version from tag
            VERSION=${GITHUB_REF#refs/tags/v}
            ARGS="$ARGS --version $VERSION"
          fi

          # Run publish script
          ./scripts/publish-crates.sh $ARGS

      - name: Verify published packages
        if: inputs.dry_run != 'true'
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.token.outputs.token }}
        run: |
          echo "ðŸ” Verifying packages are available on crates.io..."

          # Test installation of key packages
          cargo install --dry-run terraphim_agent || echo "âš ï¸  Installation dry-run failed"

          echo "âœ… Publishing workflow completed!"

      - name: Create release notes
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "ðŸ“ Creating release notes for v$TAG"

          cat > "RELEASE_NOTES_$TAG.md" << EOF
          # Terraphim AI $TAG Release

          ## Published Crates

          The following crates have been published to crates.io:

          - \`terraphim_agent\` - CLI/TUI/REPL interface
          - \`terraphim_service\` - Main service layer
          - \`terraphim_automata\` - Text processing and search
          - \`terraphim_types\` - Core type definitions
          - \`terraphim_settings\` - Configuration management
          - \`terraphim_persistence\` - Storage abstraction
          - \`terraphim_config\` - Configuration layer
          - \`terraphim_rolegraph\` - Knowledge graph implementation
          - \`terraphim_middleware\` - Search orchestration

          ## Installation

          \`\`\`bash
          cargo install terraphim_agent --features repl-full
          \`\`\`

          ## Key Changes

          - **ðŸ”„ Breaking**: Package renamed from \`terraphim-agent\` to \`terraphim-agent\`
          - **âœ¨ New**: Enhanced CLI with comprehensive subcommands
          - **âœ¨ New**: Full REPL functionality with interactive commands
          - **âœ¨ New**: Integrated AI chat capabilities
          - **âœ¨ New**: Advanced search and knowledge graph features

          Generated on: $(date)
          EOF

          echo "ðŸ“„ Release notes created: RELEASE_NOTES_$TAG.md"
