name: Publish Rust Crates

on:
  workflow_dispatch:
    inputs:
      crate:
        description: 'Specific crate to publish (optional)'
        required: false
        type: string
      dry_run:
        description: 'Run in dry-run mode only'
        required: false
        type: boolean
        default: true
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Install 1Password CLI
        run: |
          curl -sSf https://downloads.1password.com/linux/keys/1password.asc | \
            gpg --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/$(dpkg --print-architecture) stable main" | \
            sudo tee /etc/apt/sources.list.d/1password.list
          sudo apt update && sudo apt install op -y

      - name: Authenticate with 1Password
        run: |
          # Set up 1Password authentication for CI
          echo "${{ secrets.ONEPASSWORD_SERVICE_ACCOUNT_TOKEN }}" | op account add --service-account-token

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-publish-${{ hashFiles('**/Cargo.lock') }}

      - name: Test crates before publishing
        run: |
          cargo test --workspace --lib --quiet
          cargo check --workspace --all-targets --quiet

      - name: Get crates.io token from 1Password
        id: token
        run: |
          TOKEN=$(op read "op://TerraphimPlatform/crates.io.token/token")
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Publish crates in dependency order
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.token.outputs.token }}
        run: |
          # Define dependency order
          declare -a crates=(
            "terraphim_types"
            "terraphim_settings"
            "terraphim_persistence"
            "terraphim_config"
            "terraphim_automata"
            "terraphim_rolegraph"
            "terraphim_middleware"
            "terraphim_service"
            "terraphim_agent"
          )

          # If specific crate requested, only publish that one and its dependencies
          if [[ -n "${{ inputs.crate }}" ]]; then
            REQUESTED_CRATE="${{ inputs.crate }}"
            echo "Publishing specific crate: $REQUESTED_CRATE"

            # Find the crate in our dependency list
            for i in "${!crates[@]}"; do
              if [[ "${crates[$i]}" == "$REQUESTED_CRATE" ]]; then
                echo "Found crate at index $i"
                # Publish all dependencies up to this crate
                for ((j=0; j<=i; j++)); do
                  CRATE="${crates[$j]}"
                  echo "Publishing dependency $CRATE..."

                  if [[ "${{ inputs.dry_run }}" != "true" ]]; then
                    echo "ðŸš€ Publishing $CRATE to crates.io"
                    cargo publish --package "$CRATE"
                    echo "â³ Waiting 60 seconds for crates.io processing..."
                    sleep 60
                  else
                    echo "ðŸ§ª Dry run: would publish $CRATE"
                    cargo publish --dry-run --package "$CRATE"
                  fi
                done
                break
              fi
            done
          else
            # Publish all crates in dependency order
            for CRATE in "${crates[@]}"; do
              echo "ðŸ“¦ Processing $CRATE..."

              # Check if crate exists
              if ! cargo metadata --format-version 1 --no-deps | jq -r ".packages[] | select(.name == \"$CRATE\") | .name" | grep -q "$CRATE"; then
                echo "âš ï¸  Crate $CRATE not found, skipping"
                continue
              fi

              if [[ "${{ inputs.dry_run }}" != "true" ]]; then
                echo "ðŸš€ Publishing $CRATE to crates.io"
                cargo publish --package "$CRATE"
                echo "â³ Waiting 60 seconds for crates.io processing..."
                sleep 60
              else
                echo "ðŸ§ª Dry run: would publish $CRATE"
                cargo publish --dry-run --package "$CRATE"
              fi
            done
          fi

      - name: Verify published packages
        if: inputs.dry_run != 'true'
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.token.outputs.token }}
        run: |
          echo "ðŸ” Verifying packages are available on crates.io..."

          # Test installation of key packages
          cargo install --dry-run terraphim_agent || echo "âš ï¸  Installation dry-run failed"

          echo "âœ… Publishing workflow completed!"

      - name: Create release notes
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "ðŸ“ Creating release notes for v$TAG"

          cat > "RELEASE_NOTES_$TAG.md" << EOF
          # Terraphim AI $TAG Release

          ## Published Crates

          The following crates have been published to crates.io:

          - \`terraphim_agent\` - CLI/TUI/REPL interface
          - \`terraphim_service\` - Main service layer
          - \`terraphim_automata\` - Text processing and search
          - \`terraphim_types\` - Core type definitions
          - \`terraphim_settings\` - Configuration management
          - \`terraphim_persistence\` - Storage abstraction
          - \`terraphim_config\` - Configuration layer
          - \`terraphim_rolegraph\` - Knowledge graph implementation
          - \`terraphim_middleware\` - Search orchestration

          ## Installation

          \`\`\`bash
          cargo install terraphim_agent --features repl-full
          \`\`\`

          ## Key Changes

          - **ðŸ”„ Breaking**: Package renamed from \`terraphim-tui\` to \`terraphim-agent\`
          - **âœ¨ New**: Enhanced CLI with comprehensive subcommands
          - **âœ¨ New**: Full REPL functionality with interactive commands
          - **âœ¨ New**: Integrated AI chat capabilities
          - **âœ¨ New**: Advanced search and knowledge graph features

          Generated on: $(date)
          EOF

          echo "ðŸ“„ Release notes created: RELEASE_NOTES_$TAG.md"