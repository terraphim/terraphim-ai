name: Publish Tauri with Auto-Update
on:
  push:
    tags:
      - "v*"
      - "app-v*"
  workflow_dispatch:

jobs:
  publish-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            webkit-package: ""
          - platform: ubuntu-22.04
            webkit-package: "libwebkit2gtk-4.0-dev"
          - platform: windows-latest
            webkit-package: ""
    env:
      working-directory: ./desktop

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v5

      - name: Install 1Password CLI
        uses: 1password/install-cli-action@v1

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 20

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Load 1Password secrets
        uses: 1password/load-secrets-action@v2
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
        # These references must exist in the 1Password vault accessible to the service account
        # TAURI_PRIVATE_KEY is required for signing the updater
        # TAURI_PUBLIC_KEY is injected into the Tauri configuration (via op inject step below)
        secrets: |
          TAURI_PRIVATE_KEY=op://TerraphimPlatform/tauri.update.signing/TAURI_PRIVATE_KEY
          TAURI_PUBLIC_KEY=op://TerraphimPlatform/tauri.update.signing/TAURI_PUBLIC_KEY

      - name: Install dependencies (Ubuntu)
        if: startsWith(matrix.platform, 'ubuntu-')
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev ${{ matrix.webkit-package }} libjavascriptcoregtk-4.0-dev libsoup2.4-dev libayatana-appindicator3-dev librsvg2-dev pkg-config

      - name: WebKitGTK 4.1 compatibility shim (Ubuntu)
        if: startsWith(matrix.platform, 'ubuntu-')
        run: |
          set -e
          PC_DIR=/usr/lib/x86_64-linux-gnu/pkgconfig
          LIB_DIR=/usr/lib/x86_64-linux-gnu
          if [ -f "$PC_DIR/webkit2gtk-4.1.pc" ] && [ ! -f "$PC_DIR/webkit2gtk-4.0.pc" ]; then
            echo "Creating pkg-config shim for webkit2gtk 4.0 -> 4.1"
            sudo ln -sf "$PC_DIR/webkit2gtk-4.1.pc" "$PC_DIR/webkit2gtk-4.0.pc"
          fi
          if [ -f "$PC_DIR/javascriptcoregtk-4.1.pc" ] && [ ! -f "$PC_DIR/javascriptcoregtk-4.0.pc" ]; then
            echo "Creating pkg-config shim for javascriptcoregtk 4.0 -> 4.1"
            sudo ln -sf "$PC_DIR/javascriptcoregtk-4.1.pc" "$PC_DIR/javascriptcoregtk-4.0.pc"
          fi
          if [ -f "$LIB_DIR/libwebkit2gtk-4.1.so" ] && [ ! -f "$LIB_DIR/libwebkit2gtk-4.0.so" ]; then
            echo "Creating library shim for libwebkit2gtk 4.0 -> 4.1"
            sudo ln -sf "$LIB_DIR/libwebkit2gtk-4.1.so" "$LIB_DIR/libwebkit2gtk-4.0.so"
          fi
          if [ -f "$LIB_DIR/libjavascriptcoregtk-4.1.so" ] && [ ! -f "$LIB_DIR/libjavascriptcoregtk-4.0.so" ]; then
            echo "Creating library shim for libjavascriptcoregtk 4.0 -> 4.1"
            sudo ln -sf "$LIB_DIR/libjavascriptcoregtk-4.1.so" "$LIB_DIR/libjavascriptcoregtk-4.0.so"
          fi

      - name: Install frontend dependencies
        run: yarn install
        working-directory: ${{env.working-directory}}

      - name: Generate Tauri config from template
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
        working-directory: ${{env.working-directory}}
        run: |
          op inject --force -i src-tauri/tauri.conf.json.template -o src-tauri/tauri.conf.json
          chmod 600 src-tauri/tauri.conf.json

      - name: Build with Tauri (signed)
        working-directory: ${{env.working-directory}}
        env:
          # Provided by 1Password load-secrets action
          TAURI_PRIVATE_KEY: ${{ env.TAURI_PRIVATE_KEY }}
        run: |
          yarn run tauri build

      - name: Generate updater manifest
        if: matrix.platform == 'ubuntu-22.04'
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
        run: |
          node scripts/generate-latest-json.js

      - name: Upload to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          files: |
            desktop/target/release/bundle/**/*.dmg
            desktop/target/release/bundle/**/*.exe
            desktop/target/release/bundle/**/*.AppImage
            desktop/target/release/bundle/**/*.deb
            desktop/target/release/bundle/**/*.msi
            latest.json
          tag_name: ${{ github.ref_name }}
          name: "Terraphim Desktop ${{ github.ref_name }}"
          body: |
            ## Terraphim Desktop ${{ github.ref_name }}

            ### Auto-Update Enabled
            This release includes automatic update functionality. The desktop application will check for updates automatically and prompt users when new versions are available.

            ### Downloads
            - **macOS**: Download the `.dmg` file
            - **Windows**: Download the `.exe` or `.msi` file
            - **Linux**: Download the `.AppImage` or `.deb` file

            ### Changelog
            See the commit history for detailed changes in this release.
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}
