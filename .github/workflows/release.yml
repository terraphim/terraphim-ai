name: Release

# DISABLED: This workflow has been superseded by release-comprehensive.yml
# Use workflow_dispatch only for manual testing
on:
  # Disabled tag trigger - release-comprehensive.yml handles releases
  # push:
  #   tags:
  #     - "v[0-9]+.[0-9]+.[0-9]+"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 1.2.3)"
        required: true
        type: string
      skip-tests:
        description: "Skip tests (for emergency releases)"
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  RUSTUP_MAX_RETRIES: 10
  REGISTRY: ghcr.io
  IMAGE_NAME: terraphim/terraphim-ai

jobs:
  # Validate and extract version
  version-check:
    name: Version Validation
    runs-on: ubuntu-latest
    timeout-minutes: 3
    outputs:
      version: ${{ steps.version.outputs.version }}
      is-tag: ${{ steps.version.outputs.is-tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            IS_TAG=true
          elif [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            IS_TAG=false
          else
            echo "No version specified"
            exit 1
          fi

          # Validate semver format
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid version format: $VERSION"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is-tag=$IS_TAG" >> $GITHUB_OUTPUT
          echo "Releasing version: $VERSION (tag: $IS_TAG)"

      - name: Check Cargo version
        id: cargo
        run: |
          CARGO_VERSION=$(grep -m1 '^version = ' Cargo.toml | sed 's/version = "//; s/"//')
          echo "version=$CARGO_VERSION" >> $GITHUB_OUTPUT
          echo "Cargo version: $CARGO_VERSION"

      - name: Version consistency check
        run: |
          CARGO_VERSION=$(grep -m1 '^version = ' Cargo.toml | sed 's/version = "//; s/"//')
          TAG_VERSION="${{ steps.version.outputs.version }}"
          if [[ "$TAG_VERSION" != "$CARGO_VERSION" ]]; then
            echo "Version mismatch!"
            echo "Tag version: $TAG_VERSION"
            echo "Cargo version: $CARGO_VERSION"
            exit 1
          fi

  # Run comprehensive tests (native only)
  test:
    name: Comprehensive Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: version-check
    if: github.event.inputs.skip-tests != 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libglib2.0-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            pkg-config
          # Try webkit 4.1 first, fall back to 4.0
          sudo apt-get install -y libwebkit2gtk-4.1-dev libjavascriptcoregtk-4.1-dev 2>/dev/null || \
          sudo apt-get install -y libwebkit2gtk-4.0-dev libjavascriptcoregtk-4.0-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: release-test-${{ hashFiles('**/Cargo.lock') }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build frontend assets
        working-directory: ./desktop
        run: |
          yarn install --frozen-lockfile
          yarn build

      - name: Run tests
        run: |
          # Run tests for core packages only (avoid Tauri desktop)
          cargo test --release \
            -p terraphim_server \
            -p terraphim_service \
            -p terraphim_agent \
            -p terraphim_mcp_server \
            -p terraphim_automata \
            -p terraphim_rolegraph

      - name: Build server
        run: |
          cargo build --release -p terraphim_server
          ./target/release/terraphim_server --version

  # Build release artifacts
  build:
    name: Build Release Artifacts
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    needs: version-check
    strategy:
      fail-fast: false
      matrix:
        include:
          # Native Linux build (x86_64)
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            use_cross: false
            artifact_name: terraphim-ai-linux-amd64
          # Cross-compiled Linux builds
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-musl
            use_cross: true
            artifact_name: terraphim-ai-linux-amd64-musl
          - os: ubuntu-22.04
            target: aarch64-unknown-linux-gnu
            use_cross: true
            artifact_name: terraphim-ai-linux-arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies (native builds)
        if: "!matrix.use_cross"
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libglib2.0-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            pkg-config
          sudo apt-get install -y libwebkit2gtk-4.1-dev libjavascriptcoregtk-4.1-dev 2>/dev/null || \
          sudo apt-get install -y libwebkit2gtk-4.0-dev libjavascriptcoregtk-4.0-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
          targets: ${{ matrix.target }}

      - name: Install cross
        if: matrix.use_cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: release-build-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Setup Node.js (native builds only)
        if: "!matrix.use_cross"
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build frontend assets (native builds only)
        if: "!matrix.use_cross"
        working-directory: ./desktop
        run: |
          yarn install --frozen-lockfile
          yarn build

      - name: Build server binary (native)
        if: "!matrix.use_cross"
        run: |
          cargo build --release --target ${{ matrix.target }} \
            -p terraphim_server \
            -p terraphim_mcp_server

      - name: Build TUI/CLI binary
        run: |
          ${{ matrix.use_cross && 'cross' || 'cargo' }} build --release \
            --target ${{ matrix.target }} -p terraphim_agent --bin terraphim-agent

      - name: Build CLI binary
        run: |
          ${{ matrix.use_cross && 'cross' || 'cargo' }} build --release \
            --target ${{ matrix.target }} -p terraphim-cli --bin terraphim-cli

      - name: Create archive
        run: |
          mkdir -p release-artifacts
          VERSION=${{ needs.version-check.outputs.version }}

          # Copy binaries
          if [ -f "target/${{ matrix.target }}/release/terraphim_server" ]; then
            cp target/${{ matrix.target }}/release/terraphim_server release-artifacts/
          fi
          if [ -f "target/${{ matrix.target }}/release/terraphim_mcp_server" ]; then
            cp target/${{ matrix.target }}/release/terraphim_mcp_server release-artifacts/
          fi
          cp target/${{ matrix.target }}/release/terraphim-agent release-artifacts/
          cp target/${{ matrix.target }}/release/terraphim-cli release-artifacts/

          # Copy frontend assets (native builds only)
          if [ -d "desktop/dist" ]; then
            cp -r desktop/dist release-artifacts/
          fi

          # Copy configuration
          mkdir -p release-artifacts/config
          cp -r terraphim_server/default/* release-artifacts/config/

          # Create README
          cat > release-artifacts/README.md << EOF
          # Terraphim AI v${VERSION}

          ## Components

          - terraphim_server - Main HTTP API server (native builds only)
          - terraphim_mcp_server - MCP server for AI integration (native builds only)
          - terraphim-agent - Terminal UI and REPL interface
          - terraphim-cli - Command-line interface
          - dist/ - Frontend web assets (native builds only)
          - config/ - Default configuration files

          ## Quick Start

          \`\`\`bash
          ./terraphim_server --config config/terraphim_engineer_config.json
          \`\`\`

          ## Documentation

          https://docs.terraphim.ai
          EOF

          # Create archive
          ASSET_NAME="terraphim-ai-${VERSION}-${{ matrix.artifact_name }}.tar.gz"
          tar -czf ${ASSET_NAME} -C release-artifacts .
          sha256sum ${ASSET_NAME} > ${ASSET_NAME}.sha256

          echo "Created ${ASSET_NAME}"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            terraphim-ai-*.tar.gz
            terraphim-ai-*.sha256
          retention-days: 90

  # Build and publish npm package
  npm-publish:
    name: Publish NPM Package
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: version-check
    # Only publish on tag push, not manual dispatch
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install napi-rs CLI
        run: npm install -g @napi-rs/cli

      - name: Build WASM package
        working-directory: crates/terraphim_automata/wasm-test
        run: |
          wasm-pack build --target web --release --out-dir ../../../terraphim_ai_nodejs/pkg

      - name: Prepare npm package
        working-directory: terraphim_ai_nodejs
        run: |
          npm ci
          # Update version to match release
          npm version ${{ needs.version-check.outputs.version }} --no-git-tag-version || true

      - name: Publish to NPM
        working-directory: terraphim_ai_nodejs
        run: npm publish --access public || echo "NPM publish failed or package already exists"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # Build Docker images
  docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [version-check, build]
    if: always() && needs.build.result == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.base
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Create GitHub release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [version-check, build, test]
    if: always() && needs.build.result == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f -name "*.tar.gz" -o -name "*.sha256"

      - name: Generate release notes
        id: notes
        run: |
          VERSION=${{ needs.version-check.outputs.version }}

          # Get changes since last release
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [[ -n "$LAST_TAG" ]]; then
            CHANGES=$(git log --pretty=format:"- %s (%h)" $LAST_TAG..HEAD | head -50)
          else
            CHANGES="Initial release"
          fi

          cat > release_body.md << EOF
          # Terraphim AI v${VERSION}

          ## Downloads

          | Platform | Architecture | Download |
          |----------|--------------|----------|
          | Linux | x86_64 (glibc) | terraphim-ai-${VERSION}-terraphim-ai-linux-amd64.tar.gz |
          | Linux | x86_64 (musl) | terraphim-ai-${VERSION}-terraphim-ai-linux-amd64-musl.tar.gz |
          | Linux | ARM64 | terraphim-ai-${VERSION}-terraphim-ai-linux-arm64.tar.gz |

          ## Docker

          \`\`\`bash
          docker pull ghcr.io/terraphim/terraphim-ai:${VERSION}
          \`\`\`

          ## Verification

          \`\`\`bash
          sha256sum -c terraphim-ai-*.sha256
          \`\`\`

          ## Changelog

          ${CHANGES}

          ---

          Full documentation: https://docs.terraphim.ai
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Terraphim AI v${{ needs.version-check.outputs.version }}
          body_path: release_body.md
          draft: false
          prerelease: false
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
