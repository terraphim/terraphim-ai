name: Release Minimal Binaries

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0, v1.1.0, etc.
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true

env:
  CARGO_TERM_COLOR: always

jobs:
  build-minimal-binaries:
    name: Build ${{ matrix.binary }} for ${{ matrix.target }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux builds - musl for static linking
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-musl
            use_cross: true
            binary_suffix: ''
          - os: ubuntu-22.04
            target: aarch64-unknown-linux-musl
            use_cross: true
            binary_suffix: ''

          # macOS builds - both Intel and Apple Silicon
          - os: macos-latest
            target: x86_64-apple-darwin
            use_cross: false
            binary_suffix: ''
          - os: macos-latest
            target: aarch64-apple-darwin
            use_cross: false
            binary_suffix: ''

          # Windows build
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            use_cross: false
            binary_suffix: '.exe'

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross (for cross-compilation)
        if: matrix.use_cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}-minimal-release

      - name: Build terraphim-repl
        run: |
          ${{ matrix.use_cross && 'cross' || 'cargo' }} build --release \
            --target ${{ matrix.target }} \
            -p terraphim-repl

      - name: Build terraphim-cli
        run: |
          ${{ matrix.use_cross && 'cross' || 'cargo' }} build --release \
            --target ${{ matrix.target }} \
            -p terraphim-cli

      - name: Prepare artifacts (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p artifacts
          cp target/${{ matrix.target }}/release/terraphim-repl artifacts/terraphim-repl-${{ matrix.target }}
          cp target/${{ matrix.target }}/release/terraphim-cli artifacts/terraphim-cli-${{ matrix.target }}
          chmod +x artifacts/*

          # Generate SHA256 checksums
          cd artifacts
          shasum -a 256 * > SHA256SUMS
          cd ..

      - name: Prepare artifacts (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          mkdir -p artifacts
          cp target/${{ matrix.target }}/release/terraphim-repl.exe artifacts/terraphim-repl-${{ matrix.target }}.exe
          cp target/${{ matrix.target }}/release/terraphim-cli.exe artifacts/terraphim-cli-${{ matrix.target }}.exe

          # Generate SHA256 checksums
          cd artifacts
          sha256sum * > SHA256SUMS
          cd ..

      - name: Upload binary artifacts
        uses: actions/upload-artifact@v5
        with:
          name: binaries-${{ matrix.target }}
          path: artifacts/*
          retention-days: 7

  create-release:
    name: Create GitHub Release
    needs: build-minimal-binaries
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
          pattern: binaries-*
          merge-multiple: true

      - name: Consolidate checksums
        run: |
          cd release-artifacts
          # Combine all SHA256SUMS files
          cat binaries-*/SHA256SUMS 2>/dev/null > SHA256SUMS.txt || true
          # Remove individual checksum files
          find . -name SHA256SUMS -type f -delete || true
          cd ..

      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION=${{ steps.get_version.outputs.version }}

          # Check if RELEASE_NOTES_v${VERSION}.md exists
          if [ -f "RELEASE_NOTES_v${VERSION}.md" ]; then
            cp "RELEASE_NOTES_v${VERSION}.md" release_notes.md
          else
            # Generate basic release notes from commits
            cat > release_notes.md <<EOF
          # Terraphim v${VERSION}

          ## Installation

          \`\`\`bash
          cargo install terraphim-repl terraphim-cli
          \`\`\`

          ## Changes

          $(git log $(git describe --tags --abbrev=0 HEAD^)..HEAD --pretty=format:"- %s" || echo "Initial release")

          ## Binaries

          Pre-built binaries available for:
          - Linux x86_64 (musl)
          - Linux ARM64 (musl)
          - macOS x86_64 (Intel)
          - macOS ARM64 (Apple Silicon)
          - Windows x86_64

          See SHA256SUMS.txt for checksums.
          EOF
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.tag }}
          name: "Terraphim v${{ steps.get_version.outputs.version }}"
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            release-artifacts/**/*
            !release-artifacts/**/binaries-*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew-formulas:
    name: Update Homebrew Formulas
    needs: create-release
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download Linux x86_64 artifacts for checksums
        uses: actions/download-artifact@v4
        with:
          name: binaries-x86_64-unknown-linux-musl
          path: binaries

      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Calculate checksums and update formulas
        run: |
          VERSION=${{ steps.get_version.outputs.version }}

          # Calculate SHA256 for binaries
          REPL_SHA256=$(sha256sum binaries/terraphim-repl-x86_64-unknown-linux-musl | cut -d' ' -f1)
          CLI_SHA256=$(sha256sum binaries/terraphim-cli-x86_64-unknown-linux-musl | cut -d' ' -f1)

          echo "REPL SHA256: $REPL_SHA256"
          echo "CLI SHA256: $CLI_SHA256"

          # Update terraphim-repl formula
          if [ -f "homebrew-formulas/terraphim-repl.rb" ]; then
            sed -i "s/version \".*\"/version \"$VERSION\"/" homebrew-formulas/terraphim-repl.rb
            sed -i "s|download/v.*/terraphim-repl|download/v$VERSION/terraphim-repl|" homebrew-formulas/terraphim-repl.rb
            sed -i "s/sha256 \".*\"/sha256 \"$REPL_SHA256\"/" homebrew-formulas/terraphim-repl.rb
          fi

          # Update terraphim-cli formula
          if [ -f "homebrew-formulas/terraphim-cli.rb" ]; then
            sed -i "s/version \".*\"/version \"$VERSION\"/" homebrew-formulas/terraphim-cli.rb
            sed -i "s|download/v.*/terraphim-cli|download/v$VERSION/terraphim-cli|" homebrew-formulas/terraphim-cli.rb
            sed -i "s/sha256 \".*\"/sha256 \"$CLI_SHA256\"/" homebrew-formulas/terraphim-cli.rb
          fi

      - name: Commit formula updates
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet homebrew-formulas/; then
            echo "No changes to Homebrew formulas"
          else
            git add homebrew-formulas/
            git commit -m "Update Homebrew formulas for v${{ steps.get_version.outputs.version }}

            - Update version to ${{ steps.get_version.outputs.version }}
            - Update SHA256 checksums from release binaries
            - Update download URLs

            Auto-generated by release-minimal.yml workflow"

            git push origin HEAD:${{ github.ref_name }}
          fi

  publish-to-crates-io:
    name: Publish to crates.io
    needs: build-minimal-binaries
    runs-on: ubuntu-22.04
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Check if crates.io token is available
        id: check_token
        run: |
          if [ -n "${{ secrets.CARGO_REGISTRY_TOKEN }}" ]; then
            echo "token_available=true" >> $GITHUB_OUTPUT
          else
            echo "token_available=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish terraphim-repl
        if: steps.check_token.outputs.token_available == 'true'
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          cd crates/terraphim_repl

          # Check if already published
          CURRENT_VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[] | select(.name == "terraphim-repl") | .version')

          if cargo search terraphim-repl --limit 1 | grep -q "terraphim-repl = \"$CURRENT_VERSION\""; then
            echo "terraphim-repl v$CURRENT_VERSION already published, skipping"
          else
            echo "Publishing terraphim-repl v$CURRENT_VERSION..."
            cargo publish --no-verify || echo "Publish failed or already exists"
          fi

      - name: Publish terraphim-cli
        if: steps.check_token.outputs.token_available == 'true'
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          cd crates/terraphim_cli

          # Check if already published
          CURRENT_VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[] | select(.name == "terraphim-cli") | .version')

          if cargo search terraphim-cli --limit 1 | grep -q "terraphim-cli = \"$CURRENT_VERSION\""; then
            echo "terraphim-cli v$CURRENT_VERSION already published, skipping"
          else
            echo "Publishing terraphim-cli v$CURRENT_VERSION..."
            cargo publish --no-verify || echo "Publish failed or already exists"
          fi

      - name: No token available
        if: steps.check_token.outputs.token_available == 'false'
        run: |
          echo "⚠️  CARGO_REGISTRY_TOKEN not set - skipping crates.io publication"
          echo "To enable: Add CARGO_REGISTRY_TOKEN secret in repository settings"
