function ft(){}function Ne(r,t){return r!=r?t==t:r!==t||r&&typeof r=="object"||typeof r=="function"}function $e(r,...t){if(r==null)return ft;const e=r.subscribe(...t);return e.unsubscribe?()=>e.unsubscribe():e}function bt(r){let t;return $e(r,e=>t=e)(),t}Promise.resolve();const q=[];function ae(r,t){return{subscribe:ne(r,t).subscribe}}function ne(r,t=ft){let e;const s=new Set;function o(n){if(Ne(r,n)&&(r=n,e)){const c=!q.length;for(const h of s)h[1](),q.push(h,r);if(c){for(let h=0;h<q.length;h+=2)q[h][0](q[h+1]);q.length=0}}}function i(n){o(n(r))}function a(n,c=ft){const h=[n,c];return s.add(h),s.size===1&&(e=t(o)||ft),n(r),()=>{s.delete(h),s.size===0&&(e(),e=null)}}return{set:o,update:i,subscribe:a}}const ce=ne(void 0),pe=ae(void 0,r=>{ce.subscribe(t=>{r(t)})}),qt=(r,t,e,s)=>{e(r.getResourceLoading(t,s));const o=i=>{e(i)};return r.subscribe(t,o),()=>{r.unsubscribe(t,o)}},ls=(r,t)=>{const e=bt(pe),s=typeof r=="string"?r:bt(r);return ae(e.getResourceLoading(s,t),o=>{if(typeof r!="string"){let i;const a=r.subscribe(n=>{i==null||i(),o(e.getResourceLoading(n,t)),i=qt(e,n,o,t)});return()=>{a(),i==null||i()}}else return qt(e,r,o,t)})},ms=(r,t,e=!1)=>{const s=bt(pe);let o=bt(r);r.subscribe(d=>o=d);let i=o.get(t);const a=new Set;let n=!1;const c=d=>{i=d.get(t),h()},h=()=>{for(const d of a)d(i)},u=async d=>{i=d,d===void 0?o.removePropVal(t):o.set(t,d,s,!1),e&&await o.save(s),await s.notify(o)};return{set(d){u(d),h()},subscribe(d){return n||(s.subscribe(o.getSubject(),c),n=!0),a.add(d),d(i),()=>{a.delete(d),a.size===0&&(s.unsubscribe(o.getSubject(),c),n=!1)}},update(d){u(d(i)).then(()=>{h()})}}},fs=r=>{ce.set(r)},Nt=new Map;function Ie(...r){for(const t of r){for(const[e,s]of Object.entries(t.classes))Nt.set(s,e);for(const[e,s]of Object.entries(t.properties))Nt.set(s,e)}}function Te(r){return Nt.get(r)}const A={classes:{class:"https://atomicdata.dev/classes/Class",property:"https://atomicdata.dev/classes/Property",agent:"https://atomicdata.dev/classes/Agent",datatype:"https://atomicdata.dev/classes/Datatype",ontology:"https://atomicdata.dev/class/ontology"},properties:{allowsOnly:"https://atomicdata.dev/properties/allowsOnly",classtype:"https://atomicdata.dev/properties/classtype",datatype:"https://atomicdata.dev/properties/datatype",description:"https://atomicdata.dev/properties/description",incomplete:"https://atomicdata.dev/properties/incomplete",isA:"https://atomicdata.dev/properties/isA",isDynamic:"https://atomicdata.dev/properties/isDynamic",name:"https://atomicdata.dev/properties/name",parent:"https://atomicdata.dev/properties/parent",read:"https://atomicdata.dev/properties/read",recommends:"https://atomicdata.dev/properties/recommends",requires:"https://atomicdata.dev/properties/requires",shortname:"https://atomicdata.dev/properties/shortname",write:"https://atomicdata.dev/properties/write",publicKey:"https://atomicdata.dev/properties/publicKey",instances:"https://atomicdata.dev/properties/instances",properties:"https://atomicdata.dev/properties/properties",classes:"https://atomicdata.dev/properties/classes",isLocked:"https://atomicdata.dev/properties/isLocked",localId:"https://atomicdata.dev/properties/localId"}},$t={classes:{commit:"https://atomicdata.dev/classes/Commit"},properties:{subject:"https://atomicdata.dev/properties/subject",createdAt:"https://atomicdata.dev/properties/createdAt",lastCommit:"https://atomicdata.dev/properties/lastCommit",previousCommit:"https://atomicdata.dev/properties/previousCommit",signer:"https://atomicdata.dev/properties/signer",set:"https://atomicdata.dev/properties/set",push:"https://atomicdata.dev/properties/push",remove:"https://atomicdata.dev/properties/remove",destroy:"https://atomicdata.dev/properties/destroy",signature:"https://atomicdata.dev/properties/signature"}},_t={classes:{collection:"https://atomicdata.dev/classes/Collection"},properties:{members:"https://atomicdata.dev/properties/collection/members",currentPage:"https://atomicdata.dev/properties/collection/currentPage",pageSize:"https://atomicdata.dev/properties/collection/pageSize",property:"https://atomicdata.dev/properties/collection/property",totalMembers:"https://atomicdata.dev/properties/collection/totalMembers",totalPages:"https://atomicdata.dev/properties/collection/totalPages",value:"https://atomicdata.dev/properties/collection/value",sortBy:"https://atomicdata.dev/properties/collection/sortBy",sortDesc:"https://atomicdata.dev/properties/collection/sortDesc",includeExternal:"https://atomicdata.dev/properties/collection/includeExternal"}},_e={classes:{article:"https://atomicdata.dev/classes/Article",bookmark:"https://atomicdata.dev/class/Bookmark",chatroom:"https://atomicdata.dev/classes/ChatRoom",currencyProperty:"https://atomicdata.dev/ontology/data-browser/class/currency-property",dateFormat:"https://atomicdata.dev/classes/DateFormat",displayStyle:"https://atomicdata.dev/class/DisplayStyle",document:"https://atomicdata.dev/classes/Document",floatRangeProperty:"https://atomicdata.dev/classes/FloatRangeProperty",folder:"https://atomicdata.dev/classes/Folder",formattedDate:"https://atomicdata.dev/classes/FormattedDate",formattedNumber:"https://atomicdata.dev/classes/FormattedNumber",importer:"https://atomicdata.dev/classes/Importer",message:"https://atomicdata.dev/classes/Message",numberFormat:"https://atomicdata.dev/classes/NumberFormat",paragraph:"https://atomicdata.dev/classes/elements/Paragraph",rangeProperty:"https://atomicdata.dev/classes/RangeProperty",selectProperty:"https://atomicdata.dev/classes/SelectProperty",table:"https://atomicdata.dev/classes/Table",tag:"https://atomicdata.dev/classes/Tag",template:"https://atomicdata.dev/ontology/data-browser/class/template"},properties:{color:"https://atomicdata.dev/properties/color",currency:"https://atomicdata.dev/ontology/data-browser/property/currency",customNodePositioning:"https://atomicdata.dev/properties/custom-node-positioning",dateFormat:"https://atomicdata.dev/properties/dateFormat",decimalPlaces:"https://atomicdata.dev/properties/decimalPlaces",displayStyle:"https://atomicdata.dev/property/display-style",elements:"https://atomicdata.dev/properties/documents/elements",emoji:"https://atomicdata.dev/properties/emoji",image:"https://atomicdata.dev/ontology/data-browser/property/image",imageUrl:"https://atomicdata.dev/properties/imageUrl",max:"https://atomicdata.dev/properties/max",maxFloat:"https://atomicdata.dev/properties/maxFloat",messages:"https://atomicdata.dev/properties/messages",min:"https://atomicdata.dev/properties/min",minFloat:"https://atomicdata.dev/properties/minFloat",nextPage:"https://atomicdata.dev/properties/nextPage",numberFormatting:"https://atomicdata.dev/properties/numberFormatting",preview:"https://atomicdata.dev/property/preview",publishedAt:"https://atomicdata.dev/properties/published-at",replyTo:"https://atomicdata.dev/properties/replyTo",resources:"https://atomicdata.dev/ontology/data-browser/property/resources",subResources:"https://atomicdata.dev/properties/subresources",tableColumnWidths:"https://atomicdata.dev/properties/tableColumnWidths",tags:"https://atomicdata.dev/properties/tags",url:"https://atomicdata.dev/property/url"}},vt={classes:{error:"https://atomicdata.dev/classes/Error",endpoint:"https://atomicdata.dev/classes/Endpoint",drive:"https://atomicdata.dev/classes/Drive",redirect:"https://atomicdata.dev/classes/Redirect",file:"https://atomicdata.dev/classes/File",invite:"https://atomicdata.dev/classes/Invite",endpointResponse:"https://atomicdata.dev/ontology/server/class/endpoint-response"},properties:{drives:"https://atomicdata.dev/properties/drives",results:"https://atomicdata.dev/properties/endpoint/results",property:"https://atomicdata.dev/properties/search/property",redirectAgent:"https://atomicdata.dev/properties/invite/redirectAgent",agent:"https://atomicdata.dev/properties/invite/agent",publicKey:"https://atomicdata.dev/properties/invite/publicKey",target:"https://atomicdata.dev/properties/invite/target",usagesLeft:"https://atomicdata.dev/properties/invite/usagesLeft",users:"https://atomicdata.dev/properties/invite/users",write:"https://atomicdata.dev/properties/invite/write",filename:"https://atomicdata.dev/properties/filename",filesize:"https://atomicdata.dev/properties/filesize",downloadUrl:"https://atomicdata.dev/properties/downloadURL",mimetype:"https://atomicdata.dev/properties/mimetype",attachments:"https://atomicdata.dev/properties/attachments",createdBy:"https://atomicdata.dev/properties/createdBy",checksum:"https://atomicdata.dev/properties/checksum",internalId:"https://atomicdata.dev/properties/internalId",children:"https://atomicdata.dev/properties/children",parameters:"https://atomicdata.dev/properties/endpoint/parameters",destination:"https://atomicdata.dev/properties/destination",status:"https://atomicdata.dev/ontology/server/property/status",responseMessage:"https://atomicdata.dev/ontology/server/property/response-message",defaultOntology:"https://atomicdata.dev/ontology/server/property/default-ontology",imageWidth:"https://atomicdata.dev/properties/imageWidth",imageHeight:"https://atomicdata.dev/properties/imageHeight"}};function Me(){Ie(A,$t,_t,_e,vt)}function gt(){return globalThis===globalThis.window}const Le={};/*! noble-ed25519 - MIT License (c) 2019 Paul Miller (paulmillr.com) */const j=BigInt(0),g=BigInt(1),x=BigInt(2),he=BigInt(255),Kt=x**BigInt(252)+BigInt("27742317777372353535851937790883648493"),R={a:BigInt(-1),d:BigInt("37095705934669439343138083508754565189542113879843219016388785533085940283555"),P:x**he-BigInt(19),l:Kt,n:Kt,h:BigInt(8),Gx:BigInt("15112221349535400772501151409588531511454012693041857206046113283949847762202"),Gy:BigInt("46316835694926478169428394003475163141307993866256225615783033603165251855960")},de=x**BigInt(256),ot=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");BigInt("6853475219497561581579357271197624642482790079785650197046958215289687604742");const De=BigInt("25063068953384623474111414158702152701244531502492656460079210482610430750235"),ze=BigInt("54469307008909316920995813868745141605393597292927456921205312896311721017578"),We=BigInt("1159843021668779879193775521855586647937357759715417654439879720876111806838"),Ve=BigInt("40440834346308536858101042469323190826248399146238708352240133220865137265952");class v{constructor(t,e,s,o){this.x=t,this.y=e,this.z=s,this.t=o}static fromAffine(t){if(!(t instanceof E))throw new TypeError("ExtendedPoint#fromAffine: expected Point");return t.equals(E.ZERO)?v.ZERO:new v(t.x,t.y,g,p(t.x*t.y))}static toAffineBatch(t){const e=Je(t.map(s=>s.z));return t.map((s,o)=>s.toAffine(e[o]))}static normalizeZ(t){return this.toAffineBatch(t).map(this.fromAffine)}equals(t){Zt(t);const{x:e,y:s,z:o}=this,{x:i,y:a,z:n}=t,c=p(e*n),h=p(i*o),u=p(s*n),d=p(a*o);return c===h&&u===d}negate(){return new v(p(-this.x),this.y,this.z,p(-this.t))}double(){const{x:t,y:e,z:s}=this,{a:o}=R,i=p(t**x),a=p(e**x),n=p(x*p(s**x)),c=p(o*i),h=p(p((t+e)**x)-i-a),u=c+a,d=u-n,l=c-a,f=p(h*d),m=p(u*l),b=p(h*l),S=p(d*u);return new v(f,m,S,b)}add(t){Zt(t);const{x:e,y:s,z:o,t:i}=this,{x:a,y:n,z:c,t:h}=t,u=p((s-e)*(n+a)),d=p((s+e)*(n-a)),l=p(d-u);if(l===j)return this.double();const f=p(o*x*h),m=p(i*x*c),b=m+f,S=d+u,C=m-f,k=p(b*l),w=p(S*C),F=p(b*C),N=p(l*S);return new v(k,w,N,F)}subtract(t){return this.add(t.negate())}precomputeWindow(t){const e=1+256/t,s=[];let o=this,i=o;for(let a=0;a<e;a++){i=o,s.push(i);for(let n=1;n<2**(t-1);n++)i=i.add(o),s.push(i);o=i.double()}return s}wNAF(t,e){!e&&this.equals(v.BASE)&&(e=E.BASE);const s=e&&e._WINDOW_SIZE||1;if(256%s)throw new Error("Point#wNAF: Invalid precomputation window, must be power of 2");let o=e&&It.get(e);o||(o=this.precomputeWindow(s),e&&s!==1&&(o=v.normalizeZ(o),It.set(e,o)));let i=v.ZERO,a=v.ZERO;const n=1+256/s,c=2**(s-1),h=BigInt(2**s-1),u=2**s,d=BigInt(s);for(let l=0;l<n;l++){const f=l*c;let m=Number(t&h);if(t>>=d,m>c&&(m-=u,t+=g),m===0){let b=o[f];l%2&&(b=b.negate()),a=a.add(b)}else{let b=o[f+Math.abs(m)-1];m<0&&(b=b.negate()),i=i.add(b)}}return v.normalizeZ([i,a])[0]}multiply(t,e){return this.wNAF(yt(t,R.l),e)}multiplyUnsafe(t){let e=yt(t,R.l,!1);const s=v.BASE,o=v.ZERO;if(e===j)return o;if(this.equals(o)||e===g)return this;if(this.equals(s))return this.wNAF(e);let i=o,a=this;for(;e>j;)e&g&&(i=i.add(a)),a=a.double(),e>>=g;return i}isSmallOrder(){return this.multiplyUnsafe(R.h).equals(v.ZERO)}isTorsionFree(){return this.multiplyUnsafe(R.l).equals(v.ZERO)}toAffine(t=wt(this.z)){const{x:e,y:s,z:o}=this,i=p(e*t),a=p(s*t);if(p(o*t)!==g)throw new Error("invZ was invalid");return new E(i,a)}fromRistrettoBytes(){Ct()}toRistrettoBytes(){Ct()}fromRistrettoHash(){Ct()}}v.BASE=new v(R.Gx,R.Gy,g,p(R.Gx*R.Gy));v.ZERO=new v(j,g,g,j);function Zt(r){if(!(r instanceof v))throw new TypeError("ExtendedPoint expected")}function Pt(r){if(!(r instanceof B))throw new TypeError("RistrettoPoint expected")}function Ct(){throw new Error("Legacy method: switch to RistrettoPoint")}class B{constructor(t){this.ep=t}static calcElligatorRistrettoMap(t){const{d:e}=R,s=p(ot*t*t),o=p((s+g)*We);let i=BigInt(-1);const a=p((i-e*s)*p(s+e));let{isValid:n,value:c}=Lt(o,a),h=p(c*t);H(h)||(h=p(-h)),n||(c=h),n||(i=s);const u=p(i*(s-g)*Ve-a),d=c*c,l=p((c+c)*a),f=p(u*De),m=p(g-d),b=p(g+d);return new v(p(l*b),p(m*f),p(f*b),p(l*m))}static hashToCurve(t){t=J(t,64);const e=Ut(t.slice(0,32)),s=this.calcElligatorRistrettoMap(e),o=Ut(t.slice(32,64)),i=this.calcElligatorRistrettoMap(o);return new B(s.add(i))}static fromHex(t){t=J(t,32);const{a:e,d:s}=R,o="RistrettoPoint.fromHex: the hex is not valid encoding of RistrettoPoint",i=Ut(t);if(!Ke(nt(i),t)||H(i))throw new Error(o);const a=p(i*i),n=p(g+e*a),c=p(g-e*a),h=p(n*n),u=p(c*c),d=p(e*s*h-u),{isValid:l,value:f}=Qt(p(d*u)),m=p(f*c),b=p(f*m*d);let S=p((i+i)*m);H(S)&&(S=p(-S));const C=p(n*b),k=p(S*C);if(!l||H(k)||C===j)throw new Error(o);return new B(new v(S,C,g,k))}toRawBytes(){let{x:t,y:e,z:s,t:o}=this.ep;const i=p(p(s+e)*p(s-e)),a=p(t*e),{value:n}=Qt(p(i*a**x)),c=p(n*i),h=p(n*a),u=p(c*h*o);let d;if(H(o*u)){let f=p(e*ot),m=p(t*ot);t=f,e=m,d=p(c*ze)}else d=h;H(t*u)&&(e=p(-e));let l=p((s-e)*d);return H(l)&&(l=p(-l)),nt(l)}toHex(){return ct(this.toRawBytes())}toString(){return this.toHex()}equals(t){Pt(t);const e=this.ep,s=t.ep,o=p(e.x*s.y)===p(e.y*s.x),i=p(e.y*s.y)===p(e.x*s.x);return o||i}add(t){return Pt(t),new B(this.ep.add(t.ep))}subtract(t){return Pt(t),new B(this.ep.subtract(t.ep))}multiply(t){return new B(this.ep.multiply(t))}multiplyUnsafe(t){return new B(this.ep.multiplyUnsafe(t))}}B.BASE=new B(v.BASE);B.ZERO=new B(v.ZERO);const It=new WeakMap;class E{constructor(t,e){this.x=t,this.y=e}_setWindowSize(t){this._WINDOW_SIZE=t,It.delete(this)}static fromHex(t,e=!0){const{d:s,P:o}=R;t=J(t,32);const i=t.slice();i[31]=t[31]&-129;const a=X(i);if(e&&a>=o)throw new Error("Expected 0 < hex < P");if(!e&&a>=de)throw new Error("Expected 0 < hex < 2**256");const n=p(a*a),c=p(n-g),h=p(s*n+g);let{isValid:u,value:d}=Lt(c,h);if(!u)throw new Error("Point.fromHex: invalid y coordinate");const l=(d&g)===g;return(t[31]&128)!==0!==l&&(d=p(-d)),new E(d,a)}static async fromPrivateKey(t){return(await St(t)).point}toRawBytes(){const t=nt(this.y);return t[31]|=this.x&g?128:0,t}toHex(){return ct(this.toRawBytes())}toX25519(){const{y:t}=this,e=p((g+t)*wt(g-t));return nt(e)}isTorsionFree(){return v.fromAffine(this).isTorsionFree()}equals(t){return this.x===t.x&&this.y===t.y}negate(){return new E(p(-this.x),this.y)}add(t){return v.fromAffine(this).add(v.fromAffine(t)).toAffine()}subtract(t){return this.add(t.negate())}multiply(t){return v.fromAffine(this).multiply(t,this).toAffine()}}E.BASE=new E(R.Gx,R.Gy);E.ZERO=new E(j,g);class Mt{constructor(t,e){this.r=t,this.s=e,this.assertValidity()}static fromHex(t){const e=J(t,64),s=E.fromHex(e.slice(0,32),!1),o=X(e.slice(32,64));return new Mt(s,o)}assertValidity(){const{r:t,s:e}=this;if(!(t instanceof E))throw new Error("Expected Point instance");return yt(e,R.l,!1),this}toRawBytes(){const t=new Uint8Array(64);return t.set(this.r.toRawBytes()),t.set(nt(this.s),32),t}toHex(){return ct(this.toRawBytes())}}function He(...r){if(!r.every(s=>s instanceof Uint8Array))throw new Error("Expected Uint8Array list");if(r.length===1)return r[0];const t=r.reduce((s,o)=>s+o.length,0),e=new Uint8Array(t);for(let s=0,o=0;s<r.length;s++){const i=r[s];e.set(i,o),o+=i.length}return e}const Ge=Array.from({length:256},(r,t)=>t.toString(16).padStart(2,"0"));function ct(r){if(!(r instanceof Uint8Array))throw new Error("Uint8Array expected");let t="";for(let e=0;e<r.length;e++)t+=Ge[r[e]];return t}function ue(r){if(typeof r!="string")throw new TypeError("hexToBytes: expected string, got "+typeof r);if(r.length%2)throw new Error("hexToBytes: received invalid unpadded hex");const t=new Uint8Array(r.length/2);for(let e=0;e<t.length;e++){const s=e*2,o=r.slice(s,s+2),i=Number.parseInt(o,16);if(Number.isNaN(i)||i<0)throw new Error("Invalid byte sequence");t[e]=i}return t}function le(r){const t=r.toString(16).padStart(64,"0");return ue(t)}function nt(r){return le(r).reverse()}function H(r){return(p(r)&g)===g}function X(r){if(!(r instanceof Uint8Array))throw new Error("Expected Uint8Array");return BigInt("0x"+ct(Uint8Array.from(r).reverse()))}function Ut(r){return p(X(r)&x**he-g)}function p(r,t=R.P){const e=r%t;return e>=j?e:t+e}function wt(r,t=R.P){if(r===j||t<=j)throw new Error(`invert: expected positive integers, got n=${r} mod=${t}`);let e=p(r,t),s=t,o=j,i=g;for(;e!==j;){const a=s/e,n=s%e,c=o-i*a;s=e,e=n,o=i,i=c}if(s!==g)throw new Error("invert: does not exist");return p(o,t)}function Je(r,t=R.P){const e=new Array(r.length),s=r.reduce((i,a,n)=>a===j?i:(e[n]=i,p(i*a,t)),g),o=wt(s,t);return r.reduceRight((i,a,n)=>a===j?i:(e[n]=p(i*e[n],t),p(i*a,t)),o),e}function $(r,t){const{P:e}=R;let s=r;for(;t-- >j;)s*=s,s%=e;return s}function qe(r){const{P:t}=R,e=BigInt(5),s=BigInt(10),o=BigInt(20),i=BigInt(40),a=BigInt(80),n=r*r%t*r%t,c=$(n,x)*n%t,h=$(c,g)*r%t,u=$(h,e)*h%t,d=$(u,s)*u%t,l=$(d,o)*d%t,f=$(l,i)*l%t,m=$(f,a)*f%t,b=$(m,a)*f%t,S=$(b,s)*u%t;return{pow_p_5_8:$(S,x)*r%t,b2:n}}function Lt(r,t){const e=p(t*t*t),s=p(e*e*t),o=qe(r*s).pow_p_5_8;let i=p(r*e*o);const a=p(t*i*i),n=i,c=p(i*ot),h=a===r,u=a===p(-r),d=a===p(-r*ot);return h&&(i=n),(u||d)&&(i=c),H(i)&&(i=p(-i)),{isValid:h||u,value:i}}function Qt(r){return Lt(g,r)}async function Yt(...r){const t=await Rt.sha512(He(...r)),e=X(t);return p(e,R.l)}function Ke(r,t){if(r.length!==t.length)return!1;for(let e=0;e<r.length;e++)if(r[e]!==t[e])return!1;return!0}function J(r,t){const e=r instanceof Uint8Array?Uint8Array.from(r):ue(r);if(typeof t=="number"&&e.length!==t)throw new Error(`Expected ${t} bytes`);return e}function yt(r,t,e=!0){if(!t)throw new TypeError("Specify max value");if(typeof r=="number"&&Number.isSafeInteger(r)&&(r=BigInt(r)),typeof r=="bigint"&&r<t){if(e){if(j<r)return r}else if(j<=r)return r}throw new TypeError("Expected valid scalar: 0 < scalar < max")}function Ze(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}async function St(r){if(r=typeof r=="bigint"||typeof r=="number"?le(yt(r,de)):J(r),r.length!==32)throw new Error("Expected 32 bytes");const t=await Rt.sha512(r),e=Ze(t.slice(0,32)),s=t.slice(32,64),o=p(X(e),R.l),i=E.BASE.multiply(o),a=i.toRawBytes();return{head:e,prefix:s,scalar:o,point:i,pointBytes:a}}async function Qe(r){return(await St(r)).pointBytes}async function Ye(r,t){r=J(r);const{prefix:e,scalar:s,pointBytes:o}=await St(t),i=await Yt(e,r),a=E.BASE.multiply(i),n=await Yt(a.toRawBytes(),o,r),c=p(i+n*s,R.l);return new Mt(a,c).toRawBytes()}E.BASE._setWindowSize(8);const z={node:Le,web:typeof self=="object"&&"crypto"in self?self.crypto:void 0},Rt={TORSION_SUBGROUP:["0100000000000000000000000000000000000000000000000000000000000000","c7176a703d4dd84fba3c0b760d10670f2a2053fa2c39ccc64ec7fd7792ac037a","0000000000000000000000000000000000000000000000000000000000000080","26e8958fc2b227b045c3f489f2ef98f0d5dfac05d3c63339b13802886d53fc05","ecffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff7f","26e8958fc2b227b045c3f489f2ef98f0d5dfac05d3c63339b13802886d53fc85","0000000000000000000000000000000000000000000000000000000000000000","c7176a703d4dd84fba3c0b760d10670f2a2053fa2c39ccc64ec7fd7792ac03fa"],bytesToHex:ct,getExtendedPublicKey:St,mod:p,invert:wt,hashToPrivateScalar:r=>{if(r=J(r),r.length<40||r.length>1024)throw new Error("Expected 40-1024 bytes of private key as per FIPS 186");const t=p(X(r),R.l);if(t===j||t===g)throw new Error("Invalid private key");return t},randomBytes:(r=32)=>{if(z.web)return z.web.getRandomValues(new Uint8Array(r));if(z.node){const{randomBytes:t}=z.node;return new Uint8Array(t(r).buffer)}else throw new Error("The environment doesn't have randomBytes function")},randomPrivateKey:()=>Rt.randomBytes(32),sha512:async r=>{if(z.web){const t=await z.web.subtle.digest("SHA-512",r.buffer);return new Uint8Array(t)}else{if(z.node)return Uint8Array.from(z.node.createHash("sha512").update(r).digest());throw new Error("The environment doesn't have sha512 function")}},precompute(r=8,t=E.BASE){const e=t.equals(E.BASE)?t:new E(t.x,t.y);return e._setWindowSize(r),e.multiply(x),e}};function Xe(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var tr=function(r,t){t||(t={}),typeof t=="function"&&(t={cmp:t});var e=typeof t.cycles=="boolean"?t.cycles:!1,s=t.cmp&&function(i){return function(a){return function(n,c){var h={key:n,value:a[n]},u={key:c,value:a[c]};return i(h,u)}}}(t.cmp),o=[];return function i(a){if(a&&a.toJSON&&typeof a.toJSON=="function"&&(a=a.toJSON()),a!==void 0){if(typeof a=="number")return isFinite(a)?""+a:"null";if(typeof a!="object")return JSON.stringify(a);var n,c;if(Array.isArray(a)){for(c="[",n=0;n<a.length;n++)n&&(c+=","),c+=i(a[n])||"null";return c+"]"}if(a===null)return"null";if(o.indexOf(a)!==-1){if(e)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}var h=o.push(a)-1,u=Object.keys(a).sort(s&&s(a));for(c="",n=0;n<u.length;n++){var d=u[n],l=i(a[d]);l&&(c&&(c+=","),c+=JSON.stringify(d)+":"+l)}return o.splice(h,1),"{"+c+"}"}}(r)};const er=Xe(tr);var Q="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",et=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var dt=0;dt<Q.length;dt++)et[Q.charCodeAt(dt)]=dt;var me=function(r){var t=new Uint8Array(r),e,s=t.length,o="";for(e=0;e<s;e+=3)o+=Q[t[e]>>2],o+=Q[(t[e]&3)<<4|t[e+1]>>4],o+=Q[(t[e+1]&15)<<2|t[e+2]>>6],o+=Q[t[e+2]&63];return s%3===2?o=o.substring(0,o.length-1)+"=":s%3===1&&(o=o.substring(0,o.length-2)+"=="),o},fe=function(r){var t=r.length*.75,e=r.length,s,o=0,i,a,n,c;r[r.length-1]==="="&&(t--,r[r.length-2]==="="&&t--);var h=new ArrayBuffer(t),u=new Uint8Array(h);for(s=0;s<e;s+=4)i=et[r.charCodeAt(s)],a=et[r.charCodeAt(s+1)],n=et[r.charCodeAt(s+2)],c=et[r.charCodeAt(s+3)],u[o++]=i<<2|a>>4,u[o++]=(a&15)<<4|n>>2,u[o++]=(n&3)<<6|c&63;return h};/*! noble-hashes - MIT License (c) 2021 Paul Miller (paulmillr.com) */const Bt=r=>new DataView(r.buffer,r.byteOffset,r.byteLength),rr=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!rr)throw new Error("Non little-endian hardware is not supported");Array.from({length:256},(r,t)=>t.toString(16).padStart(2,"0"));(()=>{const r=typeof module<"u"&&typeof module.require=="function"&&module.require.bind(module);try{if(r){const{setImmediate:t}=r("timers");return()=>new Promise(e=>t(e))}}catch{}return()=>new Promise(t=>setTimeout(t,0))})();function sr(r){if(typeof r!="string")throw new TypeError(`utf8ToBytes expected string, got ${typeof r}`);return new TextEncoder().encode(r)}function ge(r){if(typeof r=="string"&&(r=sr(r)),!(r instanceof Uint8Array))throw new TypeError(`Expected input type is Uint8Array (got ${typeof r})`);return r}class or{clone(){return this._cloneInto()}}function Dt(r){const t=s=>r().update(ge(s)).digest(),e=r();return t.outputLen=e.outputLen,t.blockLen=e.blockLen,t.create=()=>r(),t.init=t.create,t}function ir(r,t,e,s){if(typeof r.setBigUint64=="function")return r.setBigUint64(t,e,s);const o=BigInt(32),i=BigInt(4294967295),a=Number(e>>o&i),n=Number(e&i),c=s?4:0,h=s?0:4;r.setUint32(t+c,a,s),r.setUint32(t+h,n,s)}class ar extends or{constructor(t,e,s,o){super(),this.blockLen=t,this.outputLen=e,this.padOffset=s,this.isLE=o,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(t),this.view=Bt(this.buffer)}update(t){if(this.destroyed)throw new Error("instance is destroyed");const{view:e,buffer:s,blockLen:o,finished:i}=this;if(i)throw new Error("digest() was already called");t=ge(t);const a=t.length;for(let n=0;n<a;){const c=Math.min(o-this.pos,a-n);if(c===o){const h=Bt(t);for(;o<=a-n;n+=o)this.process(h,n);continue}s.set(t.subarray(n,n+c),this.pos),this.pos+=c,n+=c,this.pos===o&&(this.process(e,0),this.pos=0)}return this.length+=t.length,this.roundClean(),this}digestInto(t){if(this.destroyed)throw new Error("instance is destroyed");if(!(t instanceof Uint8Array)||t.length<this.outputLen)throw new Error("_Sha2: Invalid output buffer");if(this.finished)throw new Error("digest() was already called");this.finished=!0;const{buffer:e,view:s,blockLen:o,isLE:i}=this;let{pos:a}=this;e[a++]=128,this.buffer.subarray(a).fill(0),this.padOffset>o-a&&(this.process(s,0),a=0);for(let c=a;c<o;c++)e[c]=0;ir(s,o-8,BigInt(this.length*8),i),this.process(s,0);const n=Bt(t);this.get().forEach((c,h)=>n.setUint32(4*h,c,i))}digest(){const{buffer:t,outputLen:e}=this;this.digestInto(t);const s=t.slice(0,e);return this.destroy(),s}_cloneInto(t){t||(t=new this.constructor),t.set(...this.get());const{blockLen:e,buffer:s,length:o,finished:i,destroyed:a,pos:n}=this;return t.length=o,t.pos=n,t.finished=i,t.destroyed=a,o%e&&t.buffer.set(s),t}}const ut=BigInt(2**32-1),Xt=BigInt(32);function nr(r,t=!1){return t?{h:Number(r&ut),l:Number(r>>Xt&ut)}:{h:Number(r>>Xt&ut)|0,l:Number(r&ut)|0}}function cr(r,t=!1){let e=new Uint32Array(r.length),s=new Uint32Array(r.length);for(let o=0;o<r.length;o++){const{h:i,l:a}=nr(r[o],t);[e[o],s[o]]=[i,a]}return[e,s]}const te=(r,t,e)=>r>>>e,ee=(r,t,e)=>r<<32-e|t>>>e,K=(r,t,e)=>r>>>e|t<<32-e,Z=(r,t,e)=>r<<32-e|t>>>e,lt=(r,t,e)=>r<<64-e|t>>>e-32,mt=(r,t,e)=>r>>>e-32|t<<64-e;function M(r,t,e,s){const o=(t>>>0)+(s>>>0);return{h:r+e+(o/2**32|0)|0,l:o|0}}const pr=(r,t,e)=>(r>>>0)+(t>>>0)+(e>>>0),hr=(r,t,e,s)=>t+e+s+(r/2**32|0)|0,dr=(r,t,e,s)=>(r>>>0)+(t>>>0)+(e>>>0)+(s>>>0),ur=(r,t,e,s,o)=>t+e+s+o+(r/2**32|0)|0,lr=(r,t,e,s,o)=>(r>>>0)+(t>>>0)+(e>>>0)+(s>>>0)+(o>>>0),mr=(r,t,e,s,o,i)=>t+e+s+o+i+(r/2**32|0)|0,[fr,gr]=cr(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),W=new Uint32Array(80),V=new Uint32Array(80);class zt extends ar{constructor(){super(128,64,16,!1),this.Ah=1779033703,this.Al=-205731576,this.Bh=-1150833019,this.Bl=-2067093701,this.Ch=1013904242,this.Cl=-23791573,this.Dh=-1521486534,this.Dl=1595750129,this.Eh=1359893119,this.El=-1377402159,this.Fh=-1694144372,this.Fl=725511199,this.Gh=528734635,this.Gl=-79577749,this.Hh=1541459225,this.Hl=327033209}get(){const{Ah:t,Al:e,Bh:s,Bl:o,Ch:i,Cl:a,Dh:n,Dl:c,Eh:h,El:u,Fh:d,Fl:l,Gh:f,Gl:m,Hh:b,Hl:S}=this;return[t,e,s,o,i,a,n,c,h,u,d,l,f,m,b,S]}set(t,e,s,o,i,a,n,c,h,u,d,l,f,m,b,S){this.Ah=t|0,this.Al=e|0,this.Bh=s|0,this.Bl=o|0,this.Ch=i|0,this.Cl=a|0,this.Dh=n|0,this.Dl=c|0,this.Eh=h|0,this.El=u|0,this.Fh=d|0,this.Fl=l|0,this.Gh=f|0,this.Gl=m|0,this.Hh=b|0,this.Hl=S|0}process(t,e){for(let w=0;w<16;w++,e+=4)W[w]=t.getUint32(e),V[w]=t.getUint32(e+=4);for(let w=16;w<80;w++){const F=W[w-15]|0,N=V[w-15]|0,At=K(F,N,1)^K(F,N,8)^te(F,N,7),Et=Z(F,N,1)^Z(F,N,8)^ee(F,N,7),T=W[w-2]|0,_=V[w-2]|0,pt=K(T,_,19)^lt(T,_,61)^te(T,_,6),jt=Z(T,_,19)^mt(T,_,61)^ee(T,_,6),ht=dr(Et,jt,V[w-7],V[w-16]),xt=ur(ht,At,pt,W[w-7],W[w-16]);W[w]=xt|0,V[w]=ht|0}let{Ah:s,Al:o,Bh:i,Bl:a,Ch:n,Cl:c,Dh:h,Dl:u,Eh:d,El:l,Fh:f,Fl:m,Gh:b,Gl:S,Hh:C,Hl:k}=this;for(let w=0;w<80;w++){const F=K(d,l,14)^K(d,l,18)^lt(d,l,41),N=Z(d,l,14)^Z(d,l,18)^mt(d,l,41),At=d&f^~d&b,Et=l&m^~l&S,T=lr(k,N,Et,gr[w],V[w]),_=mr(T,C,F,At,fr[w],W[w]),pt=T|0,jt=K(s,o,28)^lt(s,o,34)^lt(s,o,39),ht=Z(s,o,28)^mt(s,o,34)^mt(s,o,39),xt=s&i^s&n^i&n,Fe=o&a^o&c^a&c;C=b|0,k=S|0,b=f|0,S=m|0,f=d|0,m=l|0,{h:d,l}=M(h|0,u|0,_|0,pt|0),h=n|0,u=c|0,n=i|0,c=a|0,i=s|0,a=o|0;const Jt=pr(pt,ht,Fe);s=hr(Jt,_,jt,xt),o=Jt|0}({h:s,l:o}=M(this.Ah|0,this.Al|0,s|0,o|0)),{h:i,l:a}=M(this.Bh|0,this.Bl|0,i|0,a|0),{h:n,l:c}=M(this.Ch|0,this.Cl|0,n|0,c|0),{h,l:u}=M(this.Dh|0,this.Dl|0,h|0,u|0),{h:d,l}=M(this.Eh|0,this.El|0,d|0,l|0),{h:f,l:m}=M(this.Fh|0,this.Fl|0,f|0,m|0),{h:b,l:S}=M(this.Gh|0,this.Gl|0,b|0,S|0),{h:C,l:k}=M(this.Hh|0,this.Hl|0,C|0,k|0),this.set(s,o,i,a,n,c,h,u,d,l,f,m,b,S,C,k)}roundClean(){W.fill(0),V.fill(0)}destroy(){this.buffer.fill(0),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}class br extends zt{constructor(){super(),this.Ah=573645204,this.Al=-64227540,this.Bh=-1621794909,this.Bl=-934517566,this.Ch=596883563,this.Cl=1867755857,this.Dh=-1774684391,this.Dl=1497426621,this.Eh=-1775747358,this.El=-1467023389,this.Fh=-1101128155,this.Fl=1401305490,this.Gh=721525244,this.Gl=746961066,this.Hh=246885852,this.Hl=-2117784414,this.outputLen=32}}class yr extends zt{constructor(){super(),this.Ah=-876896931,this.Al=-1056596264,this.Bh=1654270250,this.Bl=914150663,this.Ch=-1856437926,this.Cl=812702999,this.Dh=355462360,this.Dl=-150054599,this.Eh=1731405415,this.El=-4191439,this.Fh=-1900787065,this.Fl=1750603025,this.Gh=-619958771,this.Gl=1694076839,this.Hh=1203062813,this.Hl=-1090891868,this.outputLen=48}}const vr=Dt(()=>new zt);Dt(()=>new br);Dt(()=>new yr);var be=(r=>(r.ATOMIC_URL="https://atomicdata.dev/datatypes/atomicURL",r.BOOLEAN="https://atomicdata.dev/datatypes/boolean",r.DATE="https://atomicdata.dev/datatypes/date",r.FLOAT="https://atomicdata.dev/datatypes/float",r.INTEGER="https://atomicdata.dev/datatypes/integer",r.MARKDOWN="https://atomicdata.dev/datatypes/markdown",r.RESOURCEARRAY="https://atomicdata.dev/datatypes/resourceArray",r.SLUG="https://atomicdata.dev/datatypes/slug",r.STRING="https://atomicdata.dev/datatypes/string",r.TIMESTAMP="https://atomicdata.dev/datatypes/timestamp",r.UNKNOWN="unknown-datatype",r))(be||{});const wr=new Set(Object.values(be)),Sr=r=>wr.has(r)?r:"unknown-datatype",Rr=/^[a-z0-9]+(?:-[a-z0-9]+)*$/,Ar=/^\d{4}-(0[1-9]|1[012])-(0[1-9]|[12][0-9]|3[01])$/,Er=(r,t)=>{let e=null;if(r===void 0)throw new Error(`Value is undefined, expected ${t}`);switch(t){case"https://atomicdata.dev/datatypes/string":{if(!tt(r)){e="Not a string";break}break}case"https://atomicdata.dev/datatypes/markdown":{if(!tt(r)){e="Not a string";break}break}case"https://atomicdata.dev/datatypes/slug":{if(!tt(r)){e="Not a slug, not even a string";break}r.match(Rr)===null&&(e="Not a valid slug. Only lowercase letters and numbers with dashes `-` between them");break}case"https://atomicdata.dev/datatypes/atomicURL":{if(!tt(r)){e="Not a string. Should be a URL";break}O.tryValidSubject(r);break}case"https://atomicdata.dev/datatypes/resourceArray":{if(!Wt(r)){e="Not an array";break}r.map((s,o)=>{try{O.tryValidSubject(s)}catch{const i=new Error("Invalid URL");throw i.index=o,i}});break}case"https://atomicdata.dev/datatypes/integer":{if(!ye(r)){e="Not a number";break}r%1!==0&&(e="Not an integer");break}case"https://atomicdata.dev/datatypes/date":{if(!tt(r)){e="Not a string";break}r.match(Ar)===null&&(e="Not a date string: YYYY-MM-DD");break}}if(e!==null)throw new Error(e)};function Wt(r){return Object.prototype.toString.call(r)==="[object Array]"}function tt(r){return typeof r=="string"}function ye(r){return typeof r=="number"}var rt=(r=>(r.Unauthorized="Unauthorized",r.NotFound="NotFound",r.Server="Server",r.Client="Client",r))(rt||{});function jr(r){return!!(r instanceof P&&(r.type==="Unauthorized"||r.message.includes("Unauthorized")))}class P extends Error{constructor(t,e="Client"){super(t),Object.setPrototypeOf(this,P.prototype),this.type=e,this.message=t;try{const s=JSON.parse(t)[A.properties.description];s&&(this.message=s)}catch{}this.message||(this.message=this.createMessage())}static fromResource(t){return new P(t.get(A.properties.description).toString())}createMessage(){switch(this.type){case"Unauthorized":return"You don't have the rights to do this.";case"NotFound":return"404 Not found.";case"Server":return"500 Unknown server error.";default:return"Unknown error."}}}class ve{constructor(){this.subscriptions=new Map}register(t,e){const s=this.subscriptions.get(t)??new Set;return s.add(e),this.subscriptions.set(t,s),()=>{s.delete(e)}}async emit(t,...e){if(!this.subscriptions.has(t))return;const s=this.subscriptions.get(t),o=async i=>i(...e);s&&await Promise.allSettled([...s].map(i=>o(i)))}hasSubscriptions(t){return this.subscriptions.has(t)}}class Vt{constructor(t,e,s,o=!1){this.__internalObject=this,this.pages=new Map,this._totalMembers=0,this.store=t,this.server=e,this.params=s,o||(this._waitForReady=this.fetchPage(0)),this.clearPages=this.clearPages.bind(this)}get property(){return this.params.property}get value(){return this.params.value}get sortBy(){return this.params.sort_by}get sortDesc(){return!!this.params.sort_desc}get pageSize(){return parseInt(this.params.page_size,10)}get totalMembers(){return this._totalMembers}get totalPages(){return Math.ceil(this.totalMembers/this.pageSize)}waitForReady(){return this._waitForReady}async getMemberWithIndex(t){if(t>=this.totalMembers)throw new Error("Index out of bounds");const e=Math.floor(t/this.pageSize);return this.pages.has(e)||(this._waitForReady=this.fetchPage(e),await this._waitForReady),this.pages.get(e).getSubjects(_t.properties.members)[t%this.pageSize]}clearPages(){this.pages=new Map}async refresh(){return this.clearPages(),this._waitForReady=this.fetchPage(0),this._waitForReady}clone(){const t=new Vt(this.store,this.server,this.params);return t._totalMembers=this._totalMembers,t._waitForReady=this._waitForReady,t.pages=this.pages,t}async*[Symbol.asyncIterator](){await this.waitForReady();for(let t=0;t<this.totalMembers;t++){const e=await this.getMemberWithIndex(t);e!==void 0&&(yield e)}}async getAllMembers(){const t=[];for await(const e of this)t.push(e);return t}async getMembersOnPage(t){return this.pages.has(t)||await this.fetchPage(t),(this.pages.get(t).props.members??[]).filter(e=>e!==void 0)}buildSubject(t){const e=new URL(`${this.server}/query`);for(const[s,o]of Object.entries(this.params))e.searchParams.set(s,o);return e.searchParams.set("current_page",`${t}`),e.toString()}async fetchPage(t){const e=this.buildSubject(t),s=await this.store.fetchResourceFromServer(e);if(!s)throw new Error("Invalid collection: resource does not exist");if(s.error)throw new Error(`Invalid collection: resource has error: ${s.error}`);this.pages.set(t,s);const o=s.props.totalMembers;if(!ye(o))throw new Error("Invalid collection: total-members is not a number");this._totalMembers=o}}class xr{constructor(t,e){this.params={page_size:"30"},this.store=t,this.server=e??new URL(t.getServerUrl()).origin}setProperty(t){return this.params.property=t,this}setValue(t){return this.params.value=t,this}setSortBy(t){return this.params.sort_by=t,this}setSortDesc(t){return this.params.sort_desc=t,this}setPageSize(t){return this.params.page_size=`${t}`,this}build(){return new Vt(this.store,this.server,this.params)}async buildAndFetch(){const t=this.build();return await t.waitForReady(),t}}const Pr={agent:"https://atomicdata.dev/classes/Agent",chatRoom:"https://atomicdata.dev/classes/ChatRoom",collection:"https://atomicdata.dev/classes/Collection",commit:"https://atomicdata.dev/classes/Commit",class:"https://atomicdata.dev/classes/Class",document:"https://atomicdata.dev/classes/Document",bookmark:"https://atomicdata.dev/class/Bookmark",elements:{paragraph:"https://atomicdata.dev/classes/elements/Paragraph"},error:"https://atomicdata.dev/classes/Error",property:"https://atomicdata.dev/classes/Property",datatype:"https://atomicdata.dev/classes/Datatype",endpoint:"https://atomicdata.dev/classes/Endpoint",drive:"https://atomicdata.dev/classes/Drive",redirect:"https://atomicdata.dev/classes/Redirect",invite:"https://atomicdata.dev/classes/Invite",file:"https://atomicdata.dev/classes/File",message:"https://atomicdata.dev/classes/Message",importer:"https://atomicdata.dev/classes/Importer",folder:"https://atomicdata.dev/classes/Folder",article:"https://atomicdata.dev/classes/Article",displayStyle:"https://atomicdata.dev/class/DisplayStyle",displayStyles:{grid:"https://atomicdata.dev/display-style/grid",list:"https://atomicdata.dev/display-style/list"},dateFormat:"https://atomicdata.dev/classes/DateFormat",numberFormat:"https://atomicdata.dev/classes/NumberFormat",constraintProperties:{rangeProperty:"https://atomicdata.dev/classes/RangeProperty",floatRangeProperty:"https://atomicdata.dev/classes/FloatRangeProperty",formattedNumber:"https://atomicdata.dev/classes/FormattedNumber",selectProperty:"https://atomicdata.dev/classes/SelectProperty",formattedDate:"https://atomicdata.dev/classes/FormattedDate"},table:"https://atomicdata.dev/classes/Table",tag:"https://atomicdata.dev/classes/Tag",ontology:"https://atomicdata.dev/class/ontology"},U={allowsOnly:"https://atomicdata.dev/properties/allowsOnly",getAll:"https://atomicdata.dev/properties/?page_size=999",children:"https://atomicdata.dev/properties/children",classType:"https://atomicdata.dev/properties/classtype",createdBy:"https://atomicdata.dev/properties/createdBy",datatype:"https://atomicdata.dev/properties/datatype",description:"https://atomicdata.dev/properties/description",drives:"https://atomicdata.dev/properties/drives",incomplete:"https://atomicdata.dev/properties/incomplete",isA:"https://atomicdata.dev/properties/isA",isDynamic:"https://atomicdata.dev/properties/isDynamic",name:"https://atomicdata.dev/properties/name",parent:"https://atomicdata.dev/properties/parent",paymentPointer:"https://atomicdata.dev/properties/paymentPointer",read:"https://atomicdata.dev/properties/read",recommends:"https://atomicdata.dev/properties/recommends",requires:"https://atomicdata.dev/properties/requires",shortname:"https://atomicdata.dev/properties/shortname",subResources:"https://atomicdata.dev/properties/subresources",write:"https://atomicdata.dev/properties/write",displayStyle:"https://atomicdata.dev/property/display-style",publishedAt:"https://atomicdata.dev/properties/published-at",agent:{publicKey:"https://atomicdata.dev/properties/publicKey"},collection:{members:"https://atomicdata.dev/properties/collection/members",currentPage:"https://atomicdata.dev/properties/collection/currentPage",pageSize:"https://atomicdata.dev/properties/collection/pageSize",property:"https://atomicdata.dev/properties/collection/property",totalMembers:"https://atomicdata.dev/properties/collection/totalMembers",totalPages:"https://atomicdata.dev/properties/collection/totalPages",value:"https://atomicdata.dev/properties/collection/value"},commit:{subject:"https://atomicdata.dev/properties/subject",createdAt:"https://atomicdata.dev/properties/createdAt",lastCommit:"https://atomicdata.dev/properties/lastCommit",previousCommit:"https://atomicdata.dev/properties/previousCommit",signer:"https://atomicdata.dev/properties/signer",set:"https://atomicdata.dev/properties/set",push:"https://atomicdata.dev/properties/push",remove:"https://atomicdata.dev/properties/remove",destroy:"https://atomicdata.dev/properties/destroy",signature:"https://atomicdata.dev/properties/signature"},document:{elements:"https://atomicdata.dev/properties/documents/elements"},endpoint:{parameters:"https://atomicdata.dev/properties/endpoint/parameters",results:"https://atomicdata.dev/properties/endpoint/results"},search:{query:"https://atomicdata.dev/properties/search/query",limit:"https://atomicdata.dev/properties/search/limit",property:"https://atomicdata.dev/properties/search/property"},redirect:{destination:"https://atomicdata.dev/properties/destination",redirectAgent:"https://atomicdata.dev/properties/invite/redirectAgent"},invite:{agent:"https://atomicdata.dev/properties/invite/agent",publicKey:"https://atomicdata.dev/properties/invite/publicKey",target:"https://atomicdata.dev/properties/invite/target",usagesLeft:"https://atomicdata.dev/properties/invite/usagesLeft",users:"https://atomicdata.dev/properties/invite/users",write:"https://atomicdata.dev/properties/invite/write"},file:{filename:"https://atomicdata.dev/properties/filename",filesize:"https://atomicdata.dev/properties/filesize",downloadUrl:"https://atomicdata.dev/properties/downloadURL",mimetype:"https://atomicdata.dev/properties/mimetype",attachments:"https://atomicdata.dev/properties/attachments"},chatRoom:{messages:"https://atomicdata.dev/properties/messages",nextPage:"https://atomicdata.dev/properties/nextPage",replyTo:"https://atomicdata.dev/properties/replyTo"},bookmark:{url:"https://atomicdata.dev/property/url",preview:"https://atomicdata.dev/property/preview",imageUrl:"https://atomicdata.dev/properties/imageUrl"},constraints:{max:"https://atomicdata.dev/properties/max",min:"https://atomicdata.dev/properties/min",maxFloat:"https://atomicdata.dev/properties/maxFloat",minFloat:"https://atomicdata.dev/properties/minFloat",numberFormatting:"https://atomicdata.dev/properties/numberFormatting",decimalPlaces:"https://atomicdata.dev/properties/decimalPlaces",dateFormat:"https://atomicdata.dev/properties/dateFormat"},table:{tableColumnWidths:"https://atomicdata.dev/properties/tableColumnWidths"},ontology:{customNodePositioning:"https://atomicdata.dev/properties/custom-node-positioning"},color:"https://atomicdata.dev/properties/color",emoji:"https://atomicdata.dev/properties/emoji",classes:"https://atomicdata.dev/properties/classes",properties:"https://atomicdata.dev/properties/properties",instances:"https://atomicdata.dev/properties/instances"},Cr={atomicUrl:"https://atomicdata.dev/datatypes/atomicURL",boolean:"https://atomicdata.dev/datatypes/boolean",date:"https://atomicdata.dev/datatypes/date",float:"https://atomicdata.dev/datatypes/float",integer:"https://atomicdata.dev/datatypes/integer",markdown:"https://atomicdata.dev/datatypes/markdown",resourceArray:"https://atomicdata.dev/datatypes/resourceArray",slug:"https://atomicdata.dev/datatypes/slug",string:"https://atomicdata.dev/datatypes/string",timestamp:"https://atomicdata.dev/datatypes/timestamp"},we={publicAgent:"https://atomicdata.dev/agents/publicAgent",displayStyleGrid:"https://atomicdata.dev/agents/publicAgent",numberFormats:{number:"https://atomicdata.dev/classes/NumberFormat/number",percentage:"https://atomicdata.dev/classes/NumberFormat/Percentage",currency:"https://atomicdata.dev/ontology/data-browser/number-format/vAikhI3z"},dateFormats:{localNumeric:"https://atomicdata.dev/classes/DateFormat/localNumeric",localLong:"https://atomicdata.dev/classes/DateFormat/localLong",localRelative:"https://atomicdata.dev/classes/DateFormat/localRelative"}},Se={import:"/import"},y={properties:U,endpoints:Se,classes:Pr,datatypes:Cr,instances:we};function Ot(r){if(r===void 0)throw new Error(`Not an array: ${r}, is ${typeof r}`);if(r.constructor===Array)return r;throw new Error(`Not an array: ${r}, is a ${typeof r}`)}const G="unknown-subject";class D{constructor(t,e){if(this.loading=!1,this.appliedCommitSignatures=new Set,this.__internalObject=this,this.propvals=new Map,this.hasQueue=!1,this.eventManager=new ve,typeof t!="string")throw new Error("Invalid subject given to resource, must be a string, found "+typeof t);this.new=!!e,this._subject=t,this.commitBuilder=new it(t)}get subject(){return this._subject}get title(){return this.get(A.properties.name)??this.get(A.properties.shortname)??this.get(vt.properties.filename)??this.subject}get props(){const t={};for(const e of this.propvals.keys()){const s=Te(e);s&&(t[s]=this.get(e))}return t}get store(){if(!this._store)throw console.error(`Resource ${this.title} has no store`),new Error("Resource has no store");return this._store}on(t,e){return this.eventManager.register(t,e)}setStore(t){this._store=t}equals(t){return this===t.__internalObject?!0:!(this.subject!==t.subject||this.new!==t.new||this.error!==t.error||this.loading!==t.loading||JSON.stringify(Array.from(this.propvals.entries()))!==JSON.stringify(Array.from(t.propvals.entries()))||JSON.stringify(Array.from(this.commitBuilder.set.entries()))!==JSON.stringify(Array.from(t.commitBuilder.set.entries())))}async canWrite(t,e){const s=this.get(U.write);if(!t)return[!1,"No agent given"];if(s&&Ot(s).includes(t))return[!0,void 0];if(s&&Ot(s).includes(we.publicAgent))return[!0,void 0];const o=this.get(U.parent);return o?o===t?[!0,void 0]:e===o?(console.warn("Circular parent",e),[!0,`Circular parent in ${this.subject}`]):await(await this.store.getResource(o)).canWrite(t,this.subject):[!1,`No write right or parent in ${this.subject}`]}clone(){const t=new D(this.subject);return t.propvals=structuredClone(this.propvals),t.loading=this.loading,t.new=this.new,t.error=structuredClone(this.error),t.commitError=this.commitError,t.commitBuilder=this.commitBuilder.clone(),t.appliedCommitSignatures=this.appliedCommitSignatures,t}isReady(){return!this.loading&&this.error===void 0}get(t){return this.propvals.get(t)}getSubjects(t){return this.getArray(t).map(e=>typeof e=="string"?e:e["@id"])}getArray(t){const e=this.propvals.get(t)??[];return Ot(e)}getClasses(){return this.getSubjects(A.properties.isA)}hasClasses(...t){return t.every(e=>this.getClasses().includes(e))}matchClass(t,e){for(const[s,o]of Object.entries(t))if(this.hasClasses(s))return o;return e}removeClasses(...t){this.set(A.properties.isA,this.getClasses().filter(e=>!t.includes(e)),!1)}addClasses(...t){const e=new Set([...this.getClasses(),...t]);return this.set(A.properties.isA,Array.from(e))}hasUnsavedChanges(){return this.commitBuilder.hasUnsavedChanges()}getCommitsCollectionSubject(){const t=new URL(this.subject);return t.pathname="/commits",t.searchParams.append("property",y.properties.commit.subject),t.searchParams.append("value",this.subject),t.searchParams.append("sort_by",y.properties.commit.createdAt),t.searchParams.append("include_nested","true"),t.searchParams.append("page_size","9999"),t.toString()}async getChildrenCollection(t=100){return await new xr(this.store).setPageSize(t).setProperty(A.properties.parent).setValue(this.subject).buildAndFetch()}async getHistory(t){const e=(await this.store.fetchResourceFromServer(this.getCommitsCollectionSubject())).get(U.collection.members),s=[];let o=new D(this.subject);for(let i=0;i<e.length;i++){const a=await this.store.getResource(e[i]),n=Or(a),c=je(o.clone(),n);s.push({commit:n,resource:c}),o=c,t&&i%30===0&&(t(Math.round(i/e.length*100)),await Ur())}return s}async setVersion(t){const e=t.resource.getPropVals();for(const s of this.propvals.keys())e.has(s)||this.remove(s);for(const[s,o]of e.entries())await this.set(s,o);await this.save()}getSubject(){return this.subject}getSubjectNoParams(){const t=new URL(this.subject);return t.origin+t.pathname}getPropVals(){return this.propvals}async getRights(){const t=[];this.getSubjects(U.write).forEach(s=>{t.push({for:s,type:"write",setIn:this.subject})}),this.getSubjects(U.read).forEach(s=>{t.push({for:s,type:"read",setIn:this.subject})});const e=this.get(U.parent);if(e){if(e===this.subject)return console.warn("Circular parent",e),t;const s=await(await this.store.getResource(e)).getRights();t.push(...s)}return t}isUnauthorized(){return!!this.error&&jr(this.error)}async destroy(t){if(this.new){this.store.removeResource(this.subject);return}const e=new it(this.subject);if(e.setDestroy(!0),t===void 0&&(t=this.store.getAgent()),(t==null?void 0:t.subject)===void 0)throw new Error("No agent has been set or passed, you cannot delete this.");const s=await e.sign(t.privateKey,t.subject),o=new URL(this.subject).origin+"/commit";await this.store.postCommit(s,o),this.store.removeResource(this.subject)}pushPropVal(t,e,s){this.push(t,e,s)}push(t,e,s){const o=this.get(t)??[];s&&(e=e.filter(i=>!o.includes(i)).filter(i=>{var a;return!((a=this.commitBuilder.push[t])!=null&&a.includes(i))}).filter((i,a,n)=>n.indexOf(i)===a)),this.commitBuilder.addPushAction(t,...e),this.propvals.set(t,[...o,...e])}removePropVal(t){this.remove(t)}remove(t){this.propvals.delete(t),this.commitBuilder.addRemoveAction(t)}removePropValLocally(t){this.propvals.delete(t)}async save(t){var e,s;if(!this.commitBuilder.hasUnsavedChanges()){console.warn(`No changes to ${this.subject}, not saving`);return}const o=this.store.getAgent()??t;if(!o)throw new Error("No agent has been set or passed, you cannot save.");if(this.hasQueue)return;if(this.isParentNew()){this.store.batchResource(this.subject);return}if(this.inProgressCommit)return this.hasQueue=!0,await this.inProgressCommit,this.hasQueue=!1,this.inProgressCommit=void 0,this.save(t);const i=(e=this.get(U.commit.lastCommit))==null?void 0:e.toString();i&&this.commitBuilder.setPreviousCommit(i);const a=this.new;let n=()=>{};this.inProgressCommit=new Promise(d=>{n=()=>{d()}});const c=this.commitBuilder.clone();this.commitBuilder=new it(this.subject);const h=await c.sign(o.privateKey,o.subject);this.appliedCommitSignatures.add(h.signature),this.loading=!1,this.new=!1;const u=new URL(this.subject).origin+"/commit";try{this.commitError=void 0,this.store.addResources(this,{skipCommitCompare:!0});const d=await this.store.postCommit(h,u);return this.setUnsafe(U.commit.lastCommit,d.id),this.store.notifyResourceSaved(this),a&&(this.store.subscribeWebSocket(this.subject),await this.store.saveBatchForParent(this.subject)),n(),d.id}catch(d){if(d.message.includes("previousCommit")){console.warn("previousCommit missing or mismatch, retrying...");const l=(s=(await this.store.fetchResourceFromServer(this.subject)).get(U.commit.lastCommit))==null?void 0:s.toString();return l&&this.setUnsafe(U.commit.lastCommit,l),n(),await this.save(o)}throw this.commitBuilder=c,this.commitError=d,this.store.addResources(this,{skipCommitCompare:!0}),n(),d}}async set(t,e,s=!0){if(this.store.isOffline()&&s&&(console.warn("Offline, not validating"),s=!1),s){const o=await this.store.getProperty(t);try{Er(e,o.datatype)}catch(i){throw i instanceof Error&&(i.message=`Error validating ${o.shortname} with value ${e} for ${this.subject}: ${i.message}`),i}}if(e===void 0){this.remove(t),this.eventManager.emit("local-change",t,e);return}this.propvals.set(t,e),this.commitBuilder.addSetAction(t,e),this.eventManager.emit("local-change",t,e)}setUnsafe(t,e){this.propvals.set(t,e)}setError(t){this.error=t}setSubject(t){O.tryValidSubject(t),this.commitBuilder.setSubject(t),this._subject=t}async refresh(){await this.store.fetchResourceFromServer(this.subject,{noWebSocket:!0})}isParentNew(){const t=this.propvals.get(A.properties.parent);return t?this.store.getResourceLoading(t).new:!1}}const Ur=()=>new Promise(r=>setTimeout(r));class Y{constructor(){this.parsedResources=[]}parseObject(t,e){return this.parsedResources=[],[this.parseJsonADResource(t,e),[...this.parsedResources]]}parseArray(t){return this.parsedResources=[],[this.parseJsonADArray(t),[...this.parsedResources]]}parseValue(t,e){return this.parsedResources=[],[this.parseJsonAdResourceValue(t,e),[...this.parsedResources]]}parseJsonADResource(t,e=G){const s=new D(e);this.parsedResources.push(s);try{for(const[o,i]of Object.entries(t)){if(o==="@id"){if(typeof i!="string")throw new Error("'@id' field must be a string");if(s.subject!=="undefined"&&s.subject!==G&&i!==s.subject)throw new Error(`Resource has wrong subject in @id. Received subject was ${i}, expected ${s.subject}.`);s.setSubject(i);continue}try{if(Wt(i)){const a=i.map(n=>this.parseJsonAdResourceValue(n,o));s.setUnsafe(o,a)}else if(typeof i=="string")s.setUnsafe(o,i);else if(typeof i=="number")s.setUnsafe(o,i);else if(typeof i=="boolean")s.setUnsafe(o,i);else{const a=this.parseJsonAdResourceValue(i,o);s.setUnsafe(o,a)}}catch(a){const n=`${`Failed creating value ${i} for key ${o} in resource ${s.subject}`}. ${a.message}`;throw new Error(n)}}s.loading=!1,s.hasClasses(vt.classes.error)&&(s.error=P.fromResource(s))}catch(o){throw o.message="Failed parsing JSON "+o.message,s.setError(o),s.loading=!1,o}return s}parseJsonAdResourceValue(t,e){if(typeof t=="string")return t;if((t==null?void 0:t.constructor)==={}.constructor)if(Object.keys(t).includes("@id")){const s=t["@id"];return this.parseJsonADResource(t),s}else return t;throw new Error(`Value ${t} in ${e} not a string or a nested Resource`)}parseJsonADArray(t){const e=[];try{for(const s of t){const o=this.parseJsonADResource(s);e.push(o)}}catch(s){throw s.message="Failed parsing JSON "+s.message,s}return e}}Rt.sha512=r=>Promise.resolve(vr(r));function Ht(){return Math.round(new Date().getTime())}class it{constructor(t,e={}){this._subject=O.removeQueryParamsFromURL(t),this._set=e.set??new Map,this._push=e.push??new Map,this._remove=e.remove??new Set,this._destroy=e.destroy,this._previousCommit=e.previousCommit}get subject(){return this._subject}get set(){return this._set}get push(){return this._push}get remove(){return this._remove}get destroy(){return this._destroy}get previousCommit(){return this._previousCommit}addSetAction(t,e){return this.removeRemoveAction(t),this._set.set(t,e),this}addPushAction(t,...e){const s=this._push.get(t)??new Set;for(const o of e)s.add(o);return this._push.set(t,s),this}addRemoveAction(t){return this._set.delete(t),this._push.delete(t),this._remove.add(t),this}removeRemoveAction(t){return this._remove.delete(t),this}setDestroy(t){return this._destroy=t,this}setPreviousCommit(t){return this._previousCommit=t,this}setSubject(t){return this._subject=t,this}async sign(t,e){return await this.signAt(e,t,Ht())}hasUnsavedChanges(){return this.set.size>0||this.push.size>0||this.destroy||this.remove.size>0}clone(){const t={set:this.set,push:this.push,remove:this.remove,destroy:this.destroy,previousCommit:this.previousCommit};return new it(this.subject,structuredClone(t))}toPlainObject(){return{subject:this.subject,set:Object.fromEntries(this.set.entries()),push:Object.fromEntries(Array.from(this.push.entries()).map(([t,e])=>[t,Array.from(e)])),remove:Array.from(this.remove),destroy:this.destroy,previousCommit:this.previousCommit}}async signAt(t,e,s){if(t===void 0)throw new Error("No agent passed to sign commit");if(!this.hasUnsavedChanges())throw new Error(`No changes to commit in ${this.subject}`);const o={...this.clone().toPlainObject(),createdAt:s,signer:t},i=Re({...o}),a=await Ae(i,e);return{...o,signature:a}}}function L(r,t,e){t in r&&t!==e&&(Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(r,t)),delete r[t])}function Re(r){return r.remove&&Object.keys(r.remove).length===0&&delete r.remove,r.set&&Object.keys(r.set).length===0&&delete r.set,r.push&&Object.keys(r.push).length===0&&delete r.push,r.destroy===!1&&delete r.destroy,L(r,"createdAt",y.properties.commit.createdAt),L(r,"subject",y.properties.commit.subject),L(r,"set",y.properties.commit.set),L(r,"push",y.properties.commit.push),L(r,"signer",y.properties.commit.signer),L(r,"signature",y.properties.commit.signature),L(r,"remove",y.properties.commit.remove),L(r,"destroy",y.properties.commit.destroy),L(r,"previousCommit",y.properties.commit.previousCommit),r[y.properties.isA]=[y.classes.commit],er(r)}const Ae=async(r,t)=>{const e=fe(t),s=new Uint8Array(e),o=new TextEncoder().encode(r),i=await Ye(o,s);return me(i)},Br=async r=>{const t=fe(r),e=new Uint8Array(t),s=await Qe(e);return me(s)};function Or(r){return{id:r.getSubject(),subject:r.get(y.properties.commit.subject),set:r.get(y.properties.commit.set),push:r.get(y.properties.commit.push),signer:r.get(y.properties.commit.signer),createdAt:r.get(y.properties.commit.createdAt),remove:r.get(y.properties.commit.remove),destroy:r.get(y.properties.commit.destroy),signature:r.get(y.properties.commit.signature)}}function Ee(r){try{const t=JSON.parse(r);if(typeof t!="object")throw new Error("Commit is not an object");const e=t[y.properties.commit.subject],s=t[y.properties.commit.set],o=t[y.properties.commit.push],i=t[y.properties.commit.signer],a=t[y.properties.commit.createdAt],n=t[y.properties.commit.remove],c=t[y.properties.commit.destroy],h=t[y.properties.commit.signature],u=t["@id"],d=t[y.properties.commit.previousCommit];if(!h)throw new Error("Commit has no signature");return{subject:e,set:s,push:o,signer:i,createdAt:a,remove:n,destroy:c,signature:h,id:u,previousCommit:d}}catch(t){throw new Error(`Could not parse commit: ${t}, Commit: ${r}`)}}function je(r,t){const{set:e,remove:s,push:o}=t;return e&&Fr(e,r),s&&Nr(s,r),o&&$r(o,r),r}function kr(r,t){const e=Ee(r),{subject:s,id:o,destroy:i,signature:a}=e;let n=t.resources.get(s);if(!n)n=new D(s);else if(n.appliedCommitSignatures.has(a))return;if(n=je(n,e),o&&n.setUnsafe(U.commit.lastCommit,o),i){t.removeResource(s);return}else n.appliedCommitSignatures.add(a),t.addResources(n,{skipCommitCompare:!0})}function Fr(r,t,e){const s=new Y,o=[];for(const[i,a]of Object.entries(r)){let n=a;if((a==null?void 0:a.constructor)==={}.constructor){const[c,h]=s.parseValue(a,i);n=c,o.push(...h)}Wt(a)&&(n=a.map(c=>{const[h,u]=s.parseValue(c,i);return o.push(...u),h})),t.setUnsafe(i,n)}}function Nr(r,t){for(const e of r)t.removePropValLocally(e)}function $r(r,t,e){const s=new Y,o=[];for(const[i,a]of Object.entries(r)){const n=t.get(i)||[],c=a.map(u=>{const[d,l]=s.parseValue(u,i);return o.push(...l),d}),h=[...n,...c];t.setUnsafe(i,h)}}async function xe(r,t){const e=Ht();if(!t.subject)throw new Error("Agent has no subject, cannot authenticate");return{"https://atomicdata.dev/properties/auth/agent":t.subject,"https://atomicdata.dev/properties/auth/requestedSubject":r,"https://atomicdata.dev/properties/auth/publicKey":await t.getPublicKey(),"https://atomicdata.dev/properties/auth/timestamp":e,"https://atomicdata.dev/properties/auth/signature":await Pe(r,t,e)}}async function Pe(r,t,e){const s=`${r} ${e}`;return await Ae(s,t.privateKey)}function Ir(r,t){var e;return!r.startsWith("http://localhost")&&((e=t==null?void 0:t.subject)==null?void 0:e.startsWith("http://localhost"))}async function re(r,t,e){const s=Ht();return t!=null&&t.subject&&!Ir(r,t)&&(e["x-atomic-public-key"]=await t.getPublicKey(),e["x-atomic-signature"]=await Pe(r,t,s),e["x-atomic-timestamp"]=s,e["x-atomic-agent"]=t==null?void 0:t.subject),e}const Tr=24*60*60*1e3,_r=(r,t,e,s=Tr)=>{const o=new Date(Date.now()+s).toUTCString(),i=encodeURIComponent(t),a=new URL(e).hostname,n=`${r}=${i};Expires=${o};Domain=${a};SameSite=Lax;path=/`;document.cookie=n},Ce="atomic_session",Ue=(r,t)=>{xe(r,t).then(e=>{_r(Ce,btoa(JSON.stringify(e)),r)})},Mr=()=>{const r=document.cookie.match(/^(.*;)?\s*atomic_session\s*=\s*[^;]+(.*)?$/);return r?r.length>0:!1},Lr=()=>{document.cookie=`${Ce}=;Max-Age=-99999999`},Dr=r=>"blob"in r&&"name"in r,zr="application/ad+json";class O{constructor(t){t&&this.setFetch(t)}static tryValidSubject(t){try{new URL(t)}catch(e){throw new Error(`Not a valid URL: ${t}. ${e}`)}}static isValidSubject(t){if(typeof t!="string")return!1;try{return O.tryValidSubject(t),!0}catch{return!1}}static removeQueryParamsFromURL(t){return t==null?void 0:t.split("?")[0]}setFetch(t){this.__fetchOverride=t.bind(globalThis)}async fetchResourceHTTP(t,e={}){const{signInfo:s,from:o,body:i,method:a}=e;let n=[];const c=new Y;let h=new D(t);try{O.tryValidSubject(t);const u={};u.Accept=zr,s&&(gt()&&t.startsWith(window.location.origin)?Mr()||Ue(s.serverURL,s.agent):await re(t,s.agent,u));let d=t;if(o!==void 0){const m=new URL(`${o}/path`);m.searchParams.set("path",t),d=m.href}const l=await this.fetch(d,{headers:u,method:a??"GET",body:i}),f=await l.text();if(l.status===200)try{const m=JSON.parse(f);if(e.noNested)h=m;else{const[b,S]=c.parseObject(m,t);h=b,n.push(...S)}}catch(m){throw new P(`Could not parse JSON from fetching ${t}. Is it an Atomic Data resource? Error message: ${m.message}`)}else throw l.status===401?new P(f,rt.Unauthorized):l.status===500?new P(f,rt.Server):l.status===404?new P(f,rt.NotFound):new P(f)}catch(u){h.setError(u),n=[h],console.error(t,u)}return h.loading=!1,{resource:h,createdResources:n}}async postCommit(t,e){const s=Re({...t}),o=new Headers;o.set("Content-Type","application/ad+json");let i;try{i=await this.fetch(e,{headers:o,method:"POST",body:s})}catch(n){throw new P(`Posting Commit to ${e} failed: ${n}`)}const a=await i.text();if(i.status!==200)throw new P(a,rt.Server);return Ee(a)}async uploadFiles(t,e,s,o){const i=new Y,a=new FormData;t.map(m=>{Dr(m)?a.append("assets",m.blob,m.name):a.append("assets",m,m.name)});const n=new URL(`${e}/upload`);n.searchParams.set("parent",o);const c=await re(n.toString(),s,{}),h={method:"POST",body:a,headers:c},u=await this.fetch(n.toString(),h),d=await u.text();if(u.status!==200)throw Error(d);const l=JSON.parse(d),[f]=i.parseArray(l);return f}fetch(...t){return this.__fetchOverride?this.__fetchOverride(...t):fetch(...t)}}class Be{constructor(t,e){if(e&&O.tryValidSubject(e),!t)throw new P("Agent requires a private key");this.client=new O,this.subject=e,this.privateKey=t}static fromSecret(t){const e=atob(t),s=JSON.parse(e),{privateKey:o,subject:i}=s;return new Be(o,i)}async getPublicKey(){if(!this.publicKey){const t=await Br(this.privateKey);this.publicKey=t}return this.publicKey}buildSecret(){const t=JSON.stringify(this);return btoa(t)}async verifyPublicKeyWithServer(){var t;if(!this.subject)throw new P("Agent has no subject");const{resource:e}=await this.client.fetchResourceHTTP(this.subject);if(e.error)throw new Error(`Could not fetch agent, and could therefore not check validity of public key. ${e.error}`);if(((t=e.get(A.properties.publicKey))==null?void 0:t.toString())!==await this.getPublicKey())throw new Error("Fetched publickey does not match current one - is the private key correct?")}}const Wr=r=>{const t=new URL(r);return t.pathname="search",t},Vr=["+","^","`",":","{","}",'"',"[","]","(",")","!","\\","*"," ","."];function Hr(r){return r.replace(new RegExp(`([${Vr.join("\\")}])`,"g"),"\\$1")}function Gr(r){return Object.entries(r).map(([t,e])=>e&&`${Hr(t)}:"${e}"`).join(" AND ")}function Jr(r,t,e={}){const{include:s=!1,limit:o=30,parents:i,filters:a}=e,n=Wr(r),c=a&&Object.keys(a).length>0&&Object.values(a).filter(h=>h&&h.length>0).length>0;return t&&n.searchParams.set("q",t),s&&n.searchParams.set("include",s.toString()),o&&n.searchParams.set("limit",o.toString()),c&&n.searchParams.set("filters",Gr(a)),i&&(Array.isArray(i)?n.searchParams.append("parents",i.join(",")):n.searchParams.append("parents",i)),n.toString()}function kt(r){if(!Gt(r))throw new Error("Parameter was not an error")}function Gt(r){return!!r&&typeof r=="object"&&qr(r)==="[object Error]"||r instanceof Error}function qr(r){return Object.prototype.toString.call(r)}const Kr="Layerr";let Zr=Kr;function Qr(){return Zr}function Yr(r){let t,e="";if(r.length===0)t={};else if(Gt(r[0]))t={cause:r[0]},e=r.slice(1).join(" ")||"";else if(r[0]&&typeof r[0]=="object")t=Object.assign({},r[0]),e=r.slice(1).join(" ")||"";else if(typeof r[0]=="string")t={},e=e=r.join(" ")||"";else throw new Error("Invalid arguments passed to Layerr");return{options:t,shortMessage:e}}class I extends Error{constructor(t,e){const s=[...arguments],{options:o,shortMessage:i}=Yr(s);let a=i;if(o.cause&&(a=`${a}: ${o.cause.message}`),super(a),this.message=a,o.name&&typeof o.name=="string"?this.name=o.name:this.name=Qr(),o.cause&&Object.defineProperty(this,"_cause",{value:o.cause}),Object.defineProperty(this,"_info",{value:{}}),o.info&&typeof o.info=="object"&&Object.assign(this._info,o.info),Error.captureStackTrace){const n=o.constructorOpt||this.constructor;Error.captureStackTrace(this,n)}}static cause(t){return kt(t),t._cause&&Gt(t._cause)?t._cause:null}static fullStack(t){kt(t);const e=I.cause(t);return e?`${t.stack}
caused by: ${I.fullStack(e)}`:t.stack??""}static info(t){kt(t);const e={},s=I.cause(t);return s&&Object.assign(e,I.info(s)),t._info&&Object.assign(e,t._info),e}toString(){let t=this.name||this.constructor.name||this.constructor.prototype.name;return this.message&&(t=`${t}: ${this.message}`),t}}const Oe="0123456789ABCDEFGHJKMNPQRSTVWXYZ",at=32,se=0xffffffffffff,Xr=10,ts=16,st=Object.freeze({source:"ulid"});function es(r){const t=rs(),e=t&&(t.crypto||t.msCrypto)||null;if(typeof(e==null?void 0:e.getRandomValues)=="function")return()=>{const s=new Uint8Array(1);return e.getRandomValues(s),s[0]/255};if(typeof(e==null?void 0:e.randomBytes)=="function")return()=>e.randomBytes(1).readUInt8()/255;throw new I({info:{code:"PRNG_DETECT",...st}},"Failed to find a reliable PRNG")}function rs(){return is()?self:typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:null}function ss(r,t){let e="";for(;r>0;r--)e=as(t)+e;return e}function os(r,t){if(isNaN(r))throw new I({info:{code:"ENC_TIME_NAN",...st}},`Time must be a number: ${r}`);if(r>se)throw new I({info:{code:"ENC_TIME_SIZE_EXCEED",...st}},`Cannot encode a time larger than ${se}: ${r}`);if(r<0)throw new I({info:{code:"ENC_TIME_NEG",...st}},`Time must be positive: ${r}`);if(Number.isInteger(r)===!1)throw new I({info:{code:"ENC_TIME_TYPE",...st}},`Time must be an integer: ${r}`);let e,s="";for(let o=t;o>0;o--)e=r%at,s=Oe.charAt(e)+s,r=(r-e)/at;return s}function is(){return typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope}function as(r){let t=Math.floor(r()*at);return t===at&&(t=at-1),Oe.charAt(t)}function ns(r,t){const e=es(),s=isNaN(r)?Date.now():r;return os(s,Xr)+ss(ts,e)}function cs(r){return r.toLowerCase().replace(/\s+/g,"-").replace(/-+/g,"-").replace(/[^\w-]+/g,"")}function oe(r,t){const e=new URL(r);e.protocol==="http:"?e.protocol="ws":e.protocol="wss",e.pathname="/ws";const s=new WebSocket(e.toString());return s.onopen=o=>ps(t,s),s.onmessage=o=>hs(o,t),s.onerror=ds,s}function ps(r,t){Tt(t,r).then(()=>{for(const e of r.subscribers.keys())r.subscribeWebSocket(e)})}function hs(r,t){if(r.data.startsWith("COMMIT ")){const e=r.data.slice(7);kr(e,t)}else if(r.data.startsWith("ERROR "))t.notifyError(r.data.slice(6));else if(r.data.startsWith("RESOURCE ")){const e=ke(r);t.addResources(e)}else console.warn("Unknown websocket message:",r)}function ds(r){console.error("websocket error:",r)}function ke(r){const t=r.data.slice(9),e=JSON.parse(t),s=new Y,[o,i]=s.parseObject(e);return i}async function Tt(r,t,e=!1){var s;const o=t.getAgent();if(!o||!o.subject)return;if(!r.url.startsWith("ws://localhost")&&(s=o==null?void 0:o.subject)!=null&&s.startsWith("http://localhost")){console.warn(`Can't authenticate localhost Agent over websocket with remote server ${r.url} because the server will nog be able to retrieve your Agent and verify your public key.`);return}const i=await xe(r.url,o);r.send("AUTHENTICATE "+JSON.stringify(i)),e&&t.resources.forEach(a=>{(a.isUnauthorized()||a.loading)&&t.fetchResourceFromServer(a.subject)})}const ie=5e3;async function us(r,t){return new Promise((e,s)=>{r.addEventListener("message",function o(i){const a=setTimeout(()=>{r.removeEventListener("message",o),s(new Error(`Request for subject "${t}" timed out after ${ie}ms.`))},ie);i.data.startsWith("RESOURCE ")&&ke(i).forEach(n=>{n.subject===t&&(clearTimeout(a),r.removeEventListener("message",o),e(n))})}),r.send("GET "+t)})}const Ft=()=>typeof WebSocket<"u";class gs{constructor(t={}){this.batchedResources=new Map,this.eventManager=new ve,this._resources=new Map,this.webSockets=new Map,this.subscribers=new Map,t.serverUrl&&this.setServerUrl(t.serverUrl),t.agent&&this.setAgent(t.agent),this.client=new O(this.injectedFetch),this.getAgent=this.getAgent.bind(this),this.setAgent=this.setAgent.bind(this)}get resources(){return this._resources}injectFetch(t){this.injectedFetch=t,this.client.setFetch(t)}addResources(t,e){for(const s of Array.isArray(t)?t:[t])this.addResource(s,e??{})}addResource(t,{skipCommitCompare:e}){if(t.setStore(this),t.get(A.properties.incomplete)){const s=this.resources.get(t.subject);if(s&&!s.loading)return}if(!e){const s=this.resources.get(t.subject);if(s&&!s.hasClasses(_t.classes.collection)&&!s.loading&&!s.new&&s.get($t.properties.lastCommit)===t.get($t.properties.lastCommit))return}this.resources.set(t.subject,t.__internalObject),this.notify(t.__internalObject)}async newResource({subject:t,parent:e,isA:s,propVals:o,noParent:i}={}){const a=Array.isArray(s)?s:[s],n=t??this.createSubject(),c=this.getResourceLoading(n,{newResource:!0});if(a[0]&&await c.addClasses(...a),i||await c.set(A.properties.parent,e??this.serverUrl),o)for(const[h,u]of Object.entries(o))await c.set(h,u);return c}async search(t,e={}){const s=Jr(this.serverUrl,t,e);return(await this.fetchResourceFromServer(s,{noWebSocket:!0})).get(vt.properties.results)??[]}async checkSubjectTaken(t){var e;const s=this.resources.get(t);if(s!=null&&s.isReady()&&!(s!=null&&s.new))return!0;try{const o=this.agent?{agent:this.agent,serverURL:this.getServerUrl()}:void 0,{createdResources:i}=await this.client.fetchResourceHTTP(t,{method:"GET",signInfo:o});if((e=i.find(a=>a.subject===t))!=null&&e.isReady())return!0}catch{}return!1}async buildUniqueSubjectFromParts(t,e){const s=t.map(i=>cs(i)).join("/"),o=e??this.getServerUrl();return this.findAvailableSubject(s,o)}createSubject(t){return t?`${t}/${this.randomPart()}`:new URL(`/${this.randomPart()}`,this.serverUrl).toString()}async fetchResourceFromServer(t,e={}){if(e.setLoading){const o=new D(t);o.loading=!0,this.addResources(o,{skipCommitCompare:!0})}const s=this.getWebSocketForSubject(t);if(!e.fromProxy&&!e.noWebSocket&&Ft()&&(s==null?void 0:s.readyState)===WebSocket.OPEN)await us(s,t);else{const o=this.agent?{agent:this.agent,serverURL:this.getServerUrl()}:void 0,{createdResources:i}=await this.client.fetchResourceHTTP(t,{from:e.fromProxy?this.getServerUrl():void 0,method:e.method,body:e.body,signInfo:o});this.addResources(i,{skipCommitCompare:!0})}return this.resources.get(t)}getAllSubjects(){return Array.from(this.resources.keys())}getDefaultWebSocket(){return this.webSockets.get(this.getServerUrl())}getWebSocketForSubject(t){const e=new URL(t),s=this.webSockets.get(e.origin);if(s)return s;typeof window<"u"&&this.webSockets.set(e.origin,oe(e.origin,this))}getServerUrl(){return this.serverUrl}getAgent(){return this.agent??void 0}getResourceLoading(t=G,e={}){if(t===G||t===null){const o=new D(G,e.newResource);return o.setStore(this),o}let s=this.resources.get(t);if(s)!e.allowIncomplete&&s.loading===!1&&s.get(A.properties.incomplete)&&(s.loading=!0,this.addResources(s),this.fetchResourceFromServer(t,e));else return s=new D(t,e.newResource),s.loading=!0,this.addResources(s),e.newResource||this.fetchResourceFromServer(t,e),s;return s}async getResourceAsync(t){return this.getResource(t)}async getResource(t){const e=this.resources.get(t);if(e&&e.isReady())return e;if(e&&!e.isReady())return new Promise((o,i)=>{const a=n=>{this.unsubscribe(t,a),o(n)};this.subscribe(t,a),setTimeout(()=>{this.unsubscribe(t,a),i(new Error(`Async Request for subject "${t}" timed out after 5000ms.`))},5e3)});const s=await this.fetchResourceFromServer(t);return this.subscribeWebSocket(t),s}async getProperty(t){var e;const s=await this.getResource(t);if(s===void 0)throw Error(`Property ${t} is not found`);if(s.error)throw Error(`Property ${t} cannot be loaded: ${s.error}`);const o=s.get(A.properties.datatype);if(o===void 0)throw Error(`Property ${t} has no datatype: ${s.getPropVals()}`);const i=s.get(A.properties.shortname);if(i===void 0)throw Error(`Property ${t} has no shortname: ${s.getPropVals()}`);const a=s.get(A.properties.description);if(a===void 0)throw Error(`Property ${t} has no description: ${s.getPropVals()}`);const n=(e=s.get(A.properties.classtype))==null?void 0:e.toString();return{subject:t,classType:n,shortname:i.toString(),description:a.toString(),datatype:Sr(o.toString()),allowsOnly:s.get(A.properties.allowsOnly)}}notifyError(t){const e=t instanceof Error?t:new Error(t);if(this.eventManager.hasSubscriptions("error"))this.eventManager.emit("error",e);else throw e}isOffline(){var t;return gt()?!((t=window==null?void 0:window.navigator)!=null&&t.onLine):!1}async notifyResourceSaved(t){await this.eventManager.emit("resource-saved",t)}async notifyResourceManuallyCreated(t){await this.eventManager.emit("resource-manually-created",t)}parseMetaTags(){const t=document.querySelectorAll('meta[property="json-ad-initial"]'),e=new Y;t.forEach(s=>{const o=s.getAttribute("content");if(o===null)return;const i=JSON.parse(atob(o)),[a,n]=e.parseObject(i);this.addResources(n)})}async preloadPropsAndClasses(){const t=new URL("/classes",this.serverUrl),e=new URL("/properties",this.serverUrl);t.searchParams.set("include_external","true"),e.searchParams.set("include_external","true"),t.searchParams.set("include_nested","true"),e.searchParams.set("include_nested","true"),t.searchParams.set("page_size","999"),e.searchParams.set("page_size","999"),await Promise.all([this.fetchResourceFromServer(t.toString()),this.fetchResourceFromServer(e.toString())])}async postToServer(t,e){return this.fetchResourceFromServer(t,{body:e,noWebSocket:!0,method:"POST"})}removeResource(t){const e=this.resources.get(t);e&&(this.resources.delete(t),this.eventManager.emit("resource-removed",e))}async renameSubject(t,e){O.tryValidSubject(e);const s=t.subject;if(await this.checkSubjectTaken(e))throw Error(`New subject name is already taken: ${e}`);t.setSubject(e);const o=this.subscribers.get(s)??[];this.subscribers.set(e,o),this.removeResource(s),this.addResources(t)}setAgent(t){this.agent=t,t&&t.subject?(gt()&&Ue(this.serverUrl,t),this.webSockets.forEach(e=>{e.readyState===e.OPEN?Tt(e,this,!0):e.onopen=()=>{Tt(e,this,!0)}})):gt()&&Lr(),this.eventManager.emit("agent-changed",t)}setServerUrl(t){if(O.tryValidSubject(t),t.substring(-1)==="/")throw Error("baseUrl should not have a trailing slash");this.serverUrl=t,this.eventManager.emit("server-url-changed",t),Ft()&&this.openWebSocket(t)}openWebSocket(t){if(Ft()){if(this.webSockets.has(t))return;this.webSockets.set(t,oe(t,this))}else console.warn("WebSockets not supported, no window available")}subscribe(t,e){if(t===void 0)throw Error("Cannot subscribe to undefined subject");let s=this.subscribers.get(t);return s===void 0&&(this.subscribeWebSocket(t),s=[]),s.push(e),this.subscribers.set(t,s),()=>{this.unsubscribe(t,e)}}subscribeWebSocket(t){if(t!==G)try{const e=this.getWebSocketForSubject(t);(e==null?void 0:e.readyState)===1&&(e==null||e.send(`SUBSCRIBE ${t}`))}catch(e){console.error(e)}}unSubscribeWebSocket(t){var e;if(t!==G)try{(e=this.getDefaultWebSocket())==null||e.send(`UNSUBSCRIBE ${t}`)}catch(s){console.error(s)}}unsubscribe(t,e){if(t===void 0)return;let s=this.subscribers.get(t);s&&(s=s==null?void 0:s.filter(o=>o!==e),this.subscribers.set(t,s))}on(t,e){return this.eventManager.register(t,e)}async uploadFiles(t,e){const s=this.getAgent();if(!s)throw Error("No agent set, cannot upload files");const o=await this.client.uploadFiles(t,this.getServerUrl(),s,e);return this.addResources(o),o.map(i=>i.subject)}async postCommit(t,e){return this.client.postCommit(t,e)}async getResourceAncestry(t){const e=[t.subject];let s=t.get(A.properties.parent);for(s&&e.push(s);s;){const o=await this.getResource(s);if(o){if(s=o.get(A.properties.parent),e.includes(s))throw new Error(`Resource ${t.subject} ancestry is cyclical. ${s} is already in the ancestry}`);e.push(s)}}return e}clientSideQuery(t){return Array.from(this.resources.values()).filter(t)}batchResource(t){const e=this._resources.get(t);if(!e)throw new Error(`Resource ${t} can not be saved because it is not in the store.`);const s=e.get(A.properties.parent);if(s===void 0)throw new Error(`Resource ${t} can not be added to a batch because it's missing a parent.`);this.batchedResources.has(s)?this.batchedResources.get(s).add(t):this.batchedResources.set(s,new Set([t]))}async saveBatchForParent(t){const e=this.batchedResources.get(t);if(e){for(const s of e){const o=this._resources.get(s);await(o==null?void 0:o.save())}this.batchedResources.delete(t)}}async importJsonAD(t,e){const s=new URL(Se.import,this.serverUrl);s.searchParams.set("parent",e.parent),s.searchParams.set("overwrite-outside",e.overwriteOutside?"true":"false");const o=await this.postToServer(s.toString(),t);if(o.error)throw o.error}randomPart(){return ns().toLowerCase()}async findAvailableSubject(t,e,s=!0){let o=new URL(`${e}/${t}`).toString();if(!s){const i=this.randomPart();o+=`-${i}`}return await this.checkSubjectTaken(o)?this.findAvailableSubject(t,e,!1):o}async notify(t){const e=t.subject,s=this.subscribers.get(e);s!==void 0&&Promise.allSettled(s.map(async o=>o(t)))}}Me();export{Be as A,ls as P,ms as T,gs as a,y as b,fs as q,pe as y};
