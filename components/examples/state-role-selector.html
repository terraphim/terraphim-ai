<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>State Management Example: Role Selector</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 40px;
      background: #f5f5f5;
    }
    .container { max-width: 800px; margin: 0 auto; }
    h1 { margin-bottom: 10px; }
    .subtitle { color: #7f8c8d; margin-bottom: 40px; font-size: 14px; }
    .demo {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Role Selector Example</h1>
    <p class="subtitle">Demonstrates nested state, derived values, and actions</p>

    <div class="demo">
      <role-selector></role-selector>
    </div>

    <div class="demo">
      <role-display></role-display>
    </div>

    <div class="demo">
      <h3>State Inspector</h3>
      <state-inspector></state-inspector>
    </div>
  </div>

  <script type="module">
    import { TerraphimElement } from '../base/terraphim-element.js';
    import { createGlobalState } from '../base/terraphim-state.js';
    import { derived, createAction } from '../base/state-helpers.js';

    // Create global state
    const globalState = createGlobalState({
      roles: [
        { id: 1, name: 'Engineer', config: { theme: 'dark', haystacks: ['GitHub', 'StackOverflow'] } },
        { id: 2, name: 'Designer', config: { theme: 'light', haystacks: ['Dribbble', 'Figma'] } },
        { id: 3, name: 'Admin', config: { theme: 'dark', haystacks: ['Internal', 'Logs'] } }
      ],
      selectedRoleId: null,
      config: {}
    });

    // Derived value: current role
    const currentRole = derived(
      globalState,
      ['roles', 'selectedRoleId'],
      (roles, selectedId) => {
        return roles.find(r => r.id === selectedId) || null;
      },
      null
    );

    // Action: select role
    const selectRole = createAction(globalState, 'selectRole', (state, roleId) => {
      const roles = state.get('roles');
      const role = roles.find(r => r.id === roleId);

      if (role) {
        state.batch(() => {
          state.set('selectedRoleId', roleId);
          state.set('config', role.config);
        });
      }
    });

    // Role Selector Component
    class RoleSelector extends TerraphimElement {
      static get properties() {
        return {
          roles: { type: Array },
          selectedRoleId: { type: Number }
        };
      }

      constructor() {
        super();
        this.attachShadow({ mode: 'open' });
      }

      onConnected() {
        this.bindState(globalState, 'roles', 'roles', { immediate: true });
        this.bindState(globalState, 'selectedRoleId', 'selectedRoleId', { immediate: true });
      }

      handleSelect(roleId) {
        selectRole(roleId);
      }

      render() {
        this.setHTML(this.shadowRoot, `
          <style>
            .roles { display: flex; gap: 10px; flex-wrap: wrap; }
            button {
              padding: 12px 24px;
              background: #ecf0f1;
              color: #333;
              border: 2px solid transparent;
              border-radius: 4px;
              cursor: pointer;
              font-size: 14px;
              transition: all 0.2s;
            }
            button:hover { background: #d5dbdb; }
            button.selected {
              background: #3498db;
              color: white;
              border-color: #2980b9;
            }
          </style>

          <h3>Select Role:</h3>
          <div class="roles">
            ${this.roles.map(role => `
              <button class="${role.id === this.selectedRoleId ? 'selected' : ''}"
                      data-role-id="${role.id}">
                ${role.name}
              </button>
            `).join('')}
          </div>
        `);

        this.$$('button').forEach(btn => {
          btn.addEventListener('click', () => {
            this.handleSelect(parseInt(btn.dataset.roleId));
          });
        });
      }
    }

    customElements.define('role-selector', RoleSelector);

    // Role Display Component
    class RoleDisplay extends TerraphimElement {
      static get properties() {
        return {
          role: { type: Object },
          config: { type: Object }
        };
      }

      constructor() {
        super();
        this.attachShadow({ mode: 'open' });
      }

      onConnected() {
        // Use derived value for current role
        currentRole.subscribe((role) => {
          this.role = role;
          this.requestUpdate();
        }, { immediate: true });

        this.bindState(globalState, 'config', 'config', { immediate: true });
      }

      render() {
        const content = this.role
          ? `
            <h4>${this.role.name} Configuration</h4>
            <p><strong>Theme:</strong> ${this.config.theme || 'None'}</p>
            <p><strong>Haystacks:</strong> ${(this.config.haystacks || []).join(', ') || 'None'}</p>
          `
          : '<p>No role selected</p>';

        this.setHTML(this.shadowRoot, `
          <style>
            .display {
              padding: 20px;
              background: #ecf0f1;
              border-radius: 4px;
            }
            h4 { margin-bottom: 15px; color: #2c3e50; }
            p { margin: 8px 0; color: #34495e; }
            strong { color: #2c3e50; }
          </style>

          <div class="display">
            ${content}
          </div>
        `);
      }
    }

    customElements.define('role-display', RoleDisplay);

    // State Inspector Component
    class StateInspector extends TerraphimElement {
      constructor() {
        super();
        this.attachShadow({ mode: 'open' });
      }

      onConnected() {
        this.bindState(globalState, 'selectedRoleId', () => this.requestUpdate());
        this.bindState(globalState, 'config', () => this.requestUpdate());
      }

      render() {
        const snapshot = globalState.getSnapshot();
        const stateJSON = JSON.stringify(snapshot, null, 2);

        this.setHTML(this.shadowRoot, `
          <style>
            pre {
              background: #f8f8f8;
              padding: 15px;
              border-radius: 4px;
              overflow-x: auto;
              font-family: 'Consolas', monospace;
              font-size: 13px;
            }
          </style>
          <pre>${stateJSON}</pre>
        `);
      }
    }

    customElements.define('state-inspector', StateInspector);

    console.log('Role Selector Example loaded.');
  </script>
</body>
</html>
