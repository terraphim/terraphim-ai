# Maintainer: Terraphim Contributors <team@terraphim.ai>
pkgname=terraphim-server
pkgver=0.2.3
pkgrel=1
pkgdesc="Terraphim AI Server - Privacy-first AI assistant backend"
arch=('x86_64')
url="https://terraphim.ai"
license=('Apache-2.0')
depends=('glibc' 'openssl')
makedepends=('rust' 'cargo')
source=("$pkgname-$pkgver.tar.gz::https://github.com/terraphim/terraphim-ai/archive/refs/tags/v$pkgver.tar.gz")
sha256sums=('SKIP')

prepare() {
    cd "$pkgname-$pkgver"
    export RUSTFLAGS="-C link-arg=-fuse-ld=lld"
    # Temporarily disable panic abort for building
    sed -i 's/panic = "abort"/# panic = "abort"/' .cargo/config.toml
}

build() {
    cd "$pkgname-$pkgver"
    export RUSTFLAGS="-C link-arg=-fuse-ld=lld"
    cargo build --release --package terraphim_server
}

check() {
    cd "$pkgname-$pkgver"
    cargo test --package terraphim_server
}

package() {
    cd "$pkgname-$pkgver"
    install -Dm755 target/release/terraphim_server "$pkgdir/usr/bin/terraphim_server"
    install -Dm644 terraphim_server/default/*.json -t "$pkgdir/etc/terraphim-ai/"
    install -Dm644 README.md -t "$pkgdir/usr/share/doc/$pkgname/"
    install -Dm644 LICENSE-Apache-2.0 -t "$pkgdir/usr/share/licenses/$pkgname/"
}