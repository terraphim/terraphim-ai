# Session: Enable terraphim-agent Sessions Feature

**Started:** 2026-01-21 13:53:00
**Task:** Create a plan to fix terraphim-agent sessions feature (currently disabled due to crates.io publishing)

## Context
- **Branch:** main
- **Recent commits:**
2ecd4a56 chore(session): close session search testing session
f17c7d90 docs(session): add v1.3.0 replace bug finding
2512e37f docs(session): complete session search testing

## Problem Statement

The `repl-sessions` feature in `terraphim_agent` is commented out because `terraphim_sessions` crate is not published to crates.io. This prevents users from using `/sessions` REPL commands.

## Task Breakdown
- [x] Investigate terraphim_sessions crate structure and dependencies (M)
- [x] Identify blockers for crates.io publishing (M)
- [x] Create plan to enable feature locally without crates.io (S)
- [x] Document alternative approaches (S)

## Progress Log

### 13:53 - Session Started
- Previous session confirmed: cla binary works but REPL sessions disabled
- Need to investigate why terraphim_sessions can't be published

## Investigation Notes

### Current State

1. **terraphim_sessions crate exists** at `crates/terraphim_sessions/`
   - Has session model, service, connectors, and enrichment modules
   - Uses path dependencies to local crates

2. **Dependencies already on crates.io** (all at v1.5.2):
   - terraphim_automata
   - terraphim_rolegraph
   - terraphim_types
   - terraphim-session-analyzer

3. **terraphim_agent feature disabled**:
   - `repl-sessions` feature commented out (line 27)
   - `terraphim_sessions` dependency commented out (line 80)
   - Feature not included in `repl-full`

### Blockers Identified

1. **terraphim_sessions not published to crates.io**
   - This is the ONLY blocker
   - All its dependencies are already published

2. **Feature name mismatch**:
   - terraphim_agent expects `cla-full` feature
   - terraphim_sessions has `tsa-full` feature

## Plan

### Option A: Publish terraphim_sessions to crates.io (Recommended)

**Steps:**
1. Update `crates/terraphim_sessions/Cargo.toml`:
   - Change path dependencies to crates.io versions
   - Add `publish = true` if needed
   - Verify feature names match

2. Publish to crates.io:
   ```bash
   cd crates/terraphim_sessions
   cargo publish --dry-run
   cargo publish
   ```

3. Update `crates/terraphim_agent/Cargo.toml`:
   - Uncomment `repl-sessions` feature
   - Uncomment `terraphim_sessions` dependency
   - Add `repl-sessions` to `repl-full`

4. Publish updated terraphim_agent to crates.io

**Effort:** Medium (1-2 hours)
**Risk:** Low

### Option B: Enable Locally with Path Dependencies

**Steps:**
1. Update `crates/terraphim_agent/Cargo.toml`:
   - Uncomment feature and dependency (keep path)
   - Add to `repl-full`

2. Build locally:
   ```bash
   cargo build -p terraphim_agent --features repl-full
   ```

**Effort:** Small (15 minutes)
**Risk:** None (doesn't affect crates.io users)
**Limitation:** Only works for local builds, not cargo install

### Option C: Dual-Source Dependencies

Use both path and version in Cargo.toml:
```toml
terraphim_sessions = { path = "../terraphim_sessions", version = "0.1.0", optional = true }
```

This allows local development while maintaining crates.io compatibility once published.

## Recommended Approach

**Start with Option B** (enable locally) to verify everything works, then proceed with **Option A** (publish) for full ecosystem support.

## Implementation Results

### Option B Applied Successfully

**Changes made to `crates/terraphim_agent/Cargo.toml`:**
1. Added `repl-sessions` to `repl-full` feature array
2. Uncommented `repl-sessions` feature definition
3. Uncommented `terraphim_sessions` dependency with fixed feature name (`tsa-full`)

**Build command:**
```bash
cargo build -p terraphim_agent --features repl-full --release
```

### Test Results

All `/sessions` commands verified working:

| Command | Status | Result |
|---------|--------|--------|
| `/sessions sources` | Working | Detected 419 Claude Code sessions |
| `/sessions import --limit N` | Working | Imports sessions from claude-code-native |
| `/sessions list --limit N` | Working | Shows session table with ID, Source, Title, Messages |
| `/sessions stats` | Working | Shows total sessions, messages, breakdown by source |
| `/sessions search <query>` | Working | Full-text search across imported sessions |

**Sample output from `/sessions search rust`:**
- 12 sessions matched from 20 imported
- Shows session IDs, sources, and project paths

### Remaining Steps

1. Publish terraphim_sessions to crates.io (for cargo install support)
2. Update terraphim_agent crates.io version

## Session End

**Completed:** 2026-01-21
**Status:** CLOSED

Option B successfully implemented. All REPL session commands functional for local development.
