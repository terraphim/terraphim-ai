<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Protocol Test</title>
</head>
<body>
    <h1>WebSocket Protocol Fix Test</h1>
    <div id="status">Connecting...</div>
    <div id="messages"></div>

    <script src="shared/websocket-client.js"></script>
    <script>
        const statusDiv = document.getElementById('status');
        const messagesDiv = document.getElementById('messages');

        function addMessage(msg) {
            const div = document.createElement('div');
            div.textContent = `${new Date().toISOString()}: ${msg}`;
            messagesDiv.appendChild(div);
        }

        // Test WebSocket client with fixed protocol
        const client = new TerraphimWebSocketClient({
            url: 'ws://127.0.0.1:8000/ws'
        });

        client.subscribe('connected', () => {
            statusDiv.textContent = 'Connected!';
            addMessage('WebSocket connected successfully');

            // Test heartbeat message format
            addMessage('Testing heartbeat message...');
        });

        client.subscribe('disconnected', (data) => {
            statusDiv.textContent = 'Disconnected';
            addMessage(`Disconnected: ${data.reason || 'Unknown reason'}`);
        });

        client.subscribe('error', (data) => {
            statusDiv.textContent = 'Error';
            addMessage(`Error: ${data.error}`);
        });

        // Capture and verify message format
        window.sentMessages = [];
        const originalSend = WebSocket.prototype.send;
        WebSocket.prototype.send = function(data) {
            try {
                const parsed = JSON.parse(data);
                window.sentMessages.push(parsed);
                addMessage(`Sending message: ${JSON.stringify(parsed, null, 2)}`);

                // Verify protocol compliance
                if (parsed.command_type) {
                    addMessage('✅ Message uses correct command_type field');
                } else if (parsed.type) {
                    addMessage('❌ Message still uses old type field!');
                } else {
                    addMessage('⚠️ Message has neither command_type nor type field');
                }
            } catch (e) {
                addMessage(`Raw message: ${data}`);
            }

            return originalSend.call(this, data);
        };

        // Test workflow start after connection
        setTimeout(() => {
            if (client.isConnected) {
                addMessage('Testing workflow start message...');
                const sessionId = client.startWorkflow('test_workflow', { test: true });
                addMessage(`Started workflow with session ID: ${sessionId}`);
            }
        }, 3000);
    </script>
</body>
</html>
